---
title: "NPAP Analysis"
author: "Andrew Qin"
date: "`r Sys.Date()`"
output: pdf_document
---

### Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages, message = FALSE}
library(tidyverse)
library(knitr)
library(rvest)
library(lubridate)
library(infer)
library(readxl)
set.seed(460)
```

```{r load-data, message = FALSE}
co_offenses <- read_csv("data/crime.csv")
wa_offenses <- read_csv("data/SPD_Crime_Data__2008-Present.csv")
mn_offenses18 <- read_csv("data/Police_Incidents_2018_PIMS.csv")
mn_offenses19 <- read_csv("data/Police_Incidents_2019.csv")
mn_offenses20 <- read_csv("data/Police_Incidents_2020.csv")
mn_offenses21 <- read_csv("data/Police_Incidents_2021.csv")
tx_offenses19 <- read_csv("data/houston_nibrs_2019.csv")
tx_offenses20 <- read_csv("data/houston_nibrs_2020.csv")
tx_offenses21 <- read_csv("data/houston_nibrs_2021.csv")
cspd <- read_csv("data/Crime_Level_Data.csv")
seattle_uof <- read_csv("data/Use_Of_Force.csv")
mn_uof <- read_csv("data/Police_Use_of_Force.csv")
cspd_uof <- read_csv("data/cspd_uof.csv")
fspd_offenses <- read_csv("data/fspd_offenses.csv")
champaign21 <- read_csv("data/2021_champaign.csv")
champaign20 <- read_csv("data/2020_champaign.csv")
champaign19 <- read_csv("data/2019_champaign.csv")
austin_offenses <- read_csv("data/austin_offenses.csv")
nibrs_conversion <- read_csv("data/NIBRS_OFFENSE_TYPE.csv")
cc_offenses19 <- read_csv("data/cape_coral_2019.csv")
cc_offenses20 <- read_csv("data/cape_coral_2020.csv")
cc_offenses21 <- read_csv("data/cape_coral_2021.csv")
tpd_offenses <- read_csv("data/tallahasee.csv")
cs_offenses <- read_csv("data/college_station.csv")
ny_offenses <- read_csv("data/nypd.csv")
ny_offenses_past <- read_csv("data/nypd_past.csv")
mc_offenses20 <- read_csv("data/mc_offenses.csv")
mc_offenses19 <- read_csv("data/mc_offenses19.csv")
aurora_offenses <- read_csv("data/aurora_crime.csv")
```

### Wrangling

According to the FBI UCR "violent crime" definition, a violent crime is comprised of four offenses: murder and nonnegligent manslaughter, forcible rape, robbery, and aggravated assault. Crucially, other common violent offenses (extortion, harassment, burglary, statutory rape, kidnapping, etc.) are excluded.

"Aggravated Assault"
Murder & Nonnegligent Manslaughter
Rape
Robbery
Sexual Assault With An Object

```{r denver-wrangling}
dates <- str_split(co_offenses$FIRST_OCCURRENCE_DATE, " ", simplify = TRUE)
dates <- dates[,1]
year <- str_split(dates, "/", simplify = TRUE)
month <- year[,1]
year <- year[,3]
dates <- tibble(date = dates, month = month, year = year)
co_offenses <- tibble(co_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))

co_offenses <- co_offenses %>% 
  mutate(violent = if_else(OFFENSE_CATEGORY_ID == "aggravated-assault" | 
           OFFENSE_CATEGORY_ID == "murder" & 
             OFFENSE_TYPE_ID != "homicide-negligent" | 
           OFFENSE_CATEGORY_ID == "robbery" | 
           OFFENSE_CATEGORY_ID == "sexual-assault", 1, 0)) %>% 
  mutate(property = if_else(OFFENSE_CATEGORY_ID == "arson" |
                              OFFENSE_CATEGORY_ID == "auto-theft" |
                              OFFENSE_CATEGORY_ID == "burglary" | 
                              OFFENSE_CATEGORY_ID == "larceny" |
                              OFFENSE_CATEGORY_ID == "theft-from-motor-vehicle", 
                            1, 0))

daily_totals <- co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  count(date)

monthly_totals <- co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  mutate(my = as.Date(my)) %>% 
  count(my)

co_violent <- co_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

co_limited_violent <- co_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

co_year_limit <- co_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
   mutate(time_period = case_when(
    date >= as.Date("2019-07-01") & date < as.Date("2020-12-31") ~ "2019-20",
    date >= as.Date("2020-07-01") & date < as.Date("2021-12-31") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

co_limited_property <- co_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

co_monthly_violent <- co_offenses %>% 
  filter(violent == 1) %>% 
  count(my) %>% 
  mutate(time_period = case_when(
   my < as.Date("2020-06-19") ~ "before_qi",
    my >= as.Date("2020-06-19") ~ "after_qi"
  ))

co_monthly_property <- co_offenses %>% 
  filter(property == 1) %>% 
  count(my) %>% 
  mutate(time_period = case_when(
   my < as.Date("2020-06-19") ~ "before_qi",
    my >= as.Date("2020-06-19") ~ "after_qi"
  ))

co_property_totals <- co_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

```

```{r cspd-wrangling}
names(cspd)[4] <- 'date'
names(cspd)[7] <- 'crime_against'
names(cspd)[11] <- 'description'

dates <- str_split(cspd$date, " ", simplify = TRUE)
dates <- dates[,1]
year <- str_split(dates, "/", simplify = TRUE)
month <- year[,1]
year <- year[,3]
dates <- tibble(date = dates, month = month, year = year)
cspd <- cspd[-4]
cspd <- tibble(cspd, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))

cspd <- cspd %>% 
  mutate(violent = if_else(description == "Aggravated Assault" | 
                             description == "Murder and Non-Negligent Manslaughter" | 
                             description == "Robbery" | 
                             description == "Sexual Assault With An Object" | 
                             description == "Forcible Fondling" |
                             description == "Forcible Rape" | 
                             description == "Forcible Sodomy", 1, 0)) %>% 
  mutate(property = if_else(description == "All Other Larceny" | 
                              description == "Arson" |
                              description == "Burglary/Breaking & Entering" | 
                              description == "Destruction/Damage/Vandalism of Property" | 
                              description == "Motor Vehicle Theft" | 
                              description == "Pocket-Picking" | 
                              description == "Shoplifting" | 
                              description == "Stolen Property Offenses" | 
                              description == "Theft From Building" | 
                              description == "Theft From Coin-Operated Device" | 
                              description == "Theft From Motor Vehicle" | 
                              description == "Theft Of Motor Vehicle Parts" |
                              description == "Purse-Snatching", 1, 0))

cspd_violent <- cspd %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

cspd_monthly_violent <- cspd %>% 
  filter(violent == 1) %>% 
  count(my) %>% 
  mutate(time_period = case_when(
   my < as.Date("2020-06-19") ~ "before_qi",
    my >= as.Date("2020-06-19") ~ "after_qi"
  ))

cspd_property <- cspd %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

cspd_monthly_property <- cspd %>% 
  filter(property == 1) %>% 
  count(my) %>% 
  mutate(time_period = case_when(
   my < as.Date("2020-06-19") ~ "before_qi",
    my >= as.Date("2020-06-19") ~ "after_qi"
  ))
```


```{r add-date-wa}
names(wa_offenses)[3] <- 'date'
names(wa_offenses)[7] <- 'crime_against'
names(wa_offenses)[8] <- 'offense_parent_group'
names(wa_offenses)[9] <- 'offense'
names(wa_offenses)[10] <- 'offense_code'
names(wa_offenses)[6] <- 'group_a_b'

wa_offenses$date <- str_split(wa_offenses$date, " ", simplify = TRUE)[,1] # Get rid of time

dates <- str_split(wa_offenses$date, "/", simplify = TRUE)
month <- dates[,1]
year <- dates[,3]
dates <- tibble(month = month, year = year)
wa_offenses <- tibble(wa_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format

wa_offenses <- wa_offenses %>% 
  mutate(violent = ifelse(offense == "Aggravated Assault" | 
           offense == "Murder & Nonnegligent Manslaughter" | 
           offense == "Rape" | 
           offense == "Robbery" |
           offense == "Sexual Assault With An Object" | 
             offense == "Fondling" | 
             offense == "Sodomy", 1, 0)) %>% 
  mutate(property = ifelse(offense == "All Other Larceny" | 
                             offense == "Arson" | 
                             offense == "Burglary/Breaking & Entering" |
                             offense == "Motor Vehicle Theft" | 
                             offense == "Shoplifting" | 
                             offense == "Stolen Property Offenses" | 
                             offense == "Pocket-picking" |
                             offense == "Theft From Building" | 
                             offense == "Theft From Coin-Operated Machine or Device" | 
                             offense == "Theft From Motor Vehicle" | 
                             offense == "Theft of Motor Vehicle Parts or Accessories" | 
                             offense == "Destruction/Damage/Vandalism of Property" | 
                             offense == "Purse-snatching", 1, 0))
daily_totals_wa <- wa_offenses %>% 
  filter(offense_parent_group != "DRIVING UNDER THE INFLUENCE") %>% 
  filter(date >= as.Date("2016-01-01")) %>% 
  count(date)

monthly_totals_wa <- wa_offenses %>% 
  filter(offense_parent_group != "DRIVING UNDER THE INFLUENCE") %>%
  filter(date >= as.Date("2016-01-01")) %>% 
  count(my) 

wa_monthly_violent <- wa_offenses %>% 
    filter(violent == 1) %>% 
  count(my) %>% 
  rename(wa_n = n)
  

wa_violent <- wa_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

wa_limited_violent <- wa_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

wa_property <- wa_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

wa_limited_property <- wa_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

wa_monthly_property <- wa_offenses %>% 
    filter(property == 1) %>% 
  count(my) %>% 
  rename(wa_n = n)
```

```{r houston-wrangling}
names(tx_offenses19)[2] <- "date"
names(tx_offenses19)[3] <- "hour"
names(tx_offenses19)[4] <- "class"
names(tx_offenses19)[5] <- "description"
names(tx_offenses19)[6] <- "offense_count"
names(tx_offenses20)[2] <- "date"
names(tx_offenses20)[3] <- "hour"
names(tx_offenses20)[4] <- "class"
names(tx_offenses20)[5] <- "description"
names(tx_offenses20)[6] <- "offense_count"
names(tx_offenses21)[2] <- "date"
names(tx_offenses21)[3] <- "hour"
names(tx_offenses21)[4] <- "class"
names(tx_offenses21)[5] <- "description"
names(tx_offenses21)[6] <- "offense_count"

tx_offenses19 <- tx_offenses19 %>% 
 select(-14)

tx_offenses <- full_join(tx_offenses19, tx_offenses20)
tx_offenses <- full_join(tx_offenses, tx_offenses21)

dates <- str_split(tx_offenses$date, "/", simplify = TRUE)
month <- dates[,1]
year <- dates[,3]
dates <- tibble(month = month, year = year)
tx_offenses <- tibble(tx_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format

tx_offenses <- tx_offenses %>% 
  select(1:6, my) %>% 
  mutate(violent = ifelse(description == "Aggravated Assault" | 
           description == "Murder, non-negligent" | 
           description == "Forcible rape" | 
           description == "Robbery" |
           description == "Sexual assault with an object" | 
             description == "Forcible fondling" | 
             description == "Forcible sodomy", 1, 0)) %>% 
  mutate(property = ifelse(description == "All other larceny" | 
                             description == "Arson" | 
                             description == "Burglary, Breaking and Entering" |
                             description == "Theft from motor vehicle" | 
                             description == "Shoplifting" | 
                             description == "Stolen property offenses" | 
                             description == "Pocket-picking" |
                             description == "Theft from building" | 
                             description == "From coin-operated machine or device" | 
                             description == "Motor vehicle theft" | 
                             description == "Theft of motor vehicle parts or accessory" | 
                             description == "Destruction, damage, vandalism" | 
                             description == "Purse-snatching", 1, 0)) 

tx_violent <- tx_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

tx_monthly_violent <- tx_offenses %>% 
    filter(violent == 1) %>% 
  count(my) %>% 
  rename(tx_n = n)

tx_property <- tx_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

tx_monthly_property <- tx_offenses %>% 
    filter(property == 1) %>% 
  count(my) %>% 
  rename(tx_n = n)
```


```{r austin-wrangling}
# names(austin_offenses)[6] <- "date"
# names(austin_offenses)[22] <- "description"

# austin_offenses <- austin_offenses %>% 
  # filter(is.na(date) == FALSE)

# dates <- str_split(austin_offenses$date, "/", simplify = TRUE)
# month <- dates[,1]
# year <- dates[,3]
# dates <- tibble(month = month, year = year)
# austin_offenses <- tibble(austin_offenses, dates) %>% 
  # mutate(date = mdy(date)) %>% 
  # mutate(my = paste0(month, "-01-", year)) %>% 
  # mutate(my = mdy(my)) # convert to date format

# austin_offenses <- austin_offenses %>% 
  # filter(year >= 2019)
# write_csv(austin_offenses, "austin_offense") # Create shortened austin offenses for commit

austin_offenses <- austin_offenses %>% 
  mutate(violent = ifelse(description == "Aggravated Assault" | 
           description == "Murder" | 
           description == "Rape" | 
           description == "Robbery", 1, 0)) %>% 
  mutate(property = ifelse(description == "Auto Theft" | 
                             description == "Burglary" | 
                             description == "Theft", 1, 0))

austin_violent <- austin_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

austin_limited_violent <- austin_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

austin_property <- austin_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

austin_limited_property <- austin_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

austin_monthly_property <- austin_offenses %>% 
    filter(property == 1) %>% 
  count(my) %>% 
  rename(austin_n = n)

austin_monthly_violent <- austin_offenses %>% 
    filter(violent == 1) %>% 
  count(my) %>% 
  rename(austin_n = n)
```


```{r fspd-wrangling}
names(fspd_offenses)[2] <- "date"
names(nibrs_conversion)[2] <- "IBRCode"

nibrs_conversion <- nibrs_conversion %>% 
  select(IBRCode, OFFENSE_NAME, CRIME_AGAINST)

fspd_offenses <- full_join(fspd_offenses, nibrs_conversion, by = "IBRCode")

dates <- str_split(fspd_offenses$date, "/", simplify = TRUE)
month <- dates[,1]
year <- dates[,3]
dates <- tibble(month = month, year = year)
fspd_offenses <- tibble(fspd_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format

fspd_offenses <- fspd_offenses %>% 
  mutate(violent = ifelse(OFFENSE_NAME == "Aggravated Assault" | 
           OFFENSE_NAME == "Murder & Nonnegligent Manslaughter" | 
           OFFENSE_NAME == "Rape" | 
           OFFENSE_NAME == "Robbery" |
           OFFENSE_NAME == "Sexual Assault With An Object" | 
             OFFENSE_NAME == "Fondling" | 
             OFFENSE_NAME == "Sodomy", 1, 0)) %>% 
  mutate(property = ifelse(OFFENSE_NAME == "All Other Larceny" | 
                             OFFENSE_NAME == "Arson" | 
                             OFFENSE_NAME == "Burglary/Breaking & Entering" |
                             OFFENSE_NAME == "Motor Vehicle Theft" | 
                             OFFENSE_NAME == "Shoplifting" | 
                             OFFENSE_NAME == "Stolen Property Offenses" | 
                             OFFENSE_NAME == "Pocket-picking" |
                             OFFENSE_NAME == "Theft From Building" | 
                             OFFENSE_NAME == "Theft From Coin-Operated Machine or Device" | 
                             OFFENSE_NAME == "Theft From Motor Vehicle" | 
                             OFFENSE_NAME == "Theft of Motor Vehicle Parts or Accessories" | 
                             OFFENSE_NAME == "Destruction/Damage/Vandalism of Property" | 
                             OFFENSE_NAME == "Purse-snatching", 1, 0))


daily_totals_fspd <- fspd_offenses %>% 
  filter(date >= as.Date("2016-01-01")) %>% 
  count(date)

monthly_totals_fspd <- fspd_offenses %>% 
  filter(date >= as.Date("2016-01-01")) %>% 
  count(my) 

fspd_monthly_violent <- fspd_offenses %>% 
    filter(violent == 1) %>% 
  count(my) %>% 
  rename(fspd_n = n)

fspd_violent <- fspd_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE) 

add_dates <- co_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, fspd_violent) %>% 
  mutate(n = 0)

fspd_violent <- full_join(antijoin, fspd_violent) %>% 
  arrange(desc(date))

fspd_limited_violent <- fspd_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

add_dates <- co_limited_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, fspd_limited_violent) %>% 
  mutate(n = 0)

fspd_limited_violent <- full_join(antijoin, fspd_limited_violent) %>% 
  arrange(desc(date))

fspd_property <-fspd_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

fspd_limited_property <- fspd_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

fspd_monthly_property <- fspd_offenses %>% 
    filter(property == 1) %>% 
  count(my) %>% 
  rename(fspd_n = n)

```


```{r champaign-wrangling}
il_offenses <- full_join(champaign19, champaign20)
il_offenses <- full_join(il_offenses, champaign21)

names(il_offenses)[1] <- 'date'
names(il_offenses)[2] <- 'description'

year <- str_split(il_offenses$date, "/", simplify = TRUE)
month <- year[,1]
year <- year[,3]
dates <- tibble(month = month, year = year)
il_offenses <- tibble(il_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))

il_offenses <- il_offenses %>% 
  mutate(violent = if_else(description == "ASSAULT-AGGRAVATED" |
                            description == "MURDER-FIRST DEGREE" | 
                             description == "MURDER-SECOND DEGREE" |
                             description == "PREDATORY CRIM SEX ASSAULT OF CHILD" | 
                             description == "SEXUAL ABUSE-AGGRAVATED" | 
                             description == "SEXUAL ABUSE-CRIMINAL" |
                             description == "SEXUAL ASSAULT-AGG CRIMINAL" | 
                             description == "SEXUAL EXPLOITATION OF A CHILD" |
                             description == "SEXUAL-ASSAULT-CRIMINAL" |
                             description == "SEXUAL ABUSE-AGGRAVATED" | 
                             description == "VIOL CHILD MURDERER/VIOLENT OFF ACT" |
                             description == "ROBBERY" |
                              description == "ROBBERY-AGGRAVATED" |
                            description == "ROBBERY-ARMED"
                           , 1, 0)) %>% 
  mutate(property = if_else(description == "ARSON" | 
                             description == "ARSON-AGGRAVATED" | 
                              description == "BURGLARY" | 
                              description == "CRIMINAL DAMAGE GOVT SUPPORT PROP" |
                              description == "BURGLARY FROM MOTOR VEHICLE" | 
                              description == "BURGLARY MOTOR VEH PARTS & ACCESS" | 
                              description == "BURGLARY RESIDENTIAL" | 
                              description == "CRIMINAL DAMAGE TO PROPERTY" | 
                              description == "CRIMINAL DEFACEMENT OF PROPERTY" | 
                              description == "DAMAGE TO CITY PROPERTY" | 
                              description == "DAMAGING PROPERTY" | 
                              description == "POCKET-PICKING" | 
                              description == "RETAIL THEFT" | 
                              description == "THEFT $500 AND UNDER" |
                              description == "THEFT BY LESSEE" |
                              description == "THEFT FROM COIN-OP MACHINE/DEVICE" |
                              description == "THEFT FROM MOTOR VEHICLE" |
                              description == "THEFT GENERALLY" |
                              description == "THEFT OF LOST/MISLAID PROP" |
                              description == "THEFT OF LOST/MISLAID PROPERTY" |
                              description == "THEFT OF MOTOR VEH PARTS & ACCESS" |
                              description == "THEFT OVER $500" |
                              description == "THEFT-AGG IDENTITY" |
                              description == "THEFT-IDENTITY" |
                              description == "THEFT-LABOR OR SERVICES" |
                              description == "THEFT-LOST/MISLAID PROPERTY" |
                              description == "THEFT-MOTOR VEHICLE" |
                              description == "THEFT-RETAIL" |
                              description == "THEFT-AGG IDENTITY", 1, 0))

il_violent <- il_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

add_dates <- co_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, il_violent) %>% 
  mutate(n = 0)

il_monthly_violent <- il_offenses %>% 
    filter(violent == 1) %>% 
  count(my) %>% 
  rename(il_n = n)

il_monthly_property <- il_offenses %>% 
    filter(property == 1) %>% 
  count(my) %>% 
  rename(il_n = n)

il_violent <- full_join(antijoin, il_violent) %>% 
  arrange(desc(date))

il_limited_violent <- il_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

add_dates <- co_limited_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, il_limited_violent) %>% 
  mutate(n = 0)

il_limited_violent <- full_join(antijoin, il_limited_violent) %>% 
  arrange(desc(date))

il_limited_property <- il_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-31") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-01") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

add_dates <- co_limited_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, il_limited_property) %>% 
  mutate(n = 0)

il_limited_property <- full_join(antijoin, il_limited_property) %>% 
  arrange(desc(date))



il_property <- il_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

add_dates <- co_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, il_property) %>% 
  mutate(n = 0)

il_property <- full_join(antijoin, il_property) %>% 
  arrange(desc(date))
```



```{r mn-wrangling, message = FALSE}
mn_offenses18 <- mn_offenses18 %>% 
  mutate(precinct = as.character(precinct))
mn_offenses21 <- mn_offenses21 %>% 
  mutate(precinct = as.character(precinct))
mn_offenses <- full_join(mn_offenses18, mn_offenses19)
mn_offenses <- full_join(mn_offenses, mn_offenses20)
mn_offenses <- full_join(mn_offenses, mn_offenses21)

mn_offenses$reportedDate <- str_split(mn_offenses$reportedDate, " ", 
                                      simplify = TRUE)[,1] # Get rid of time

dates <- str_split(mn_offenses$reportedDate, "/", simplify = TRUE)
month <- dates[,2]
year <- dates[,1]
dates <- tibble(month = month, year = year)
mn_offenses <- tibble(mn_offenses, dates) %>% 
  mutate(reportedDate = ymd(reportedDate)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format

names(mn_offenses)[6] = "date"
mn_offenses <- mn_offenses %>% 
  mutate(violent = ifelse(
    UCRCode == "01" | UCRCode == "05" & description != "OBS - ASLT-POLICE/EMERG P" 
    & description != "ASLT 4-LESS THAN SUBST HARM" & 
      description != "DISARM A POLICE OFFICER" | UCRCode == "03" | UCRCode == "04" |
    description == "ROBBERY INCLUDING AUTO THEFT", 1, 0)) %>% 
  mutate(property = ifelse(UCRCode == "06" | UCRCode == "07" | UCRCode == "08" | 
                             UCRCode == "10", 1, 0))

mn_violent <- mn_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

mn_property_totals <- mn_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)
```

```{r cape-coral-wrangling}
names(cc_offenses)[3] <- "date"

cc_offenses <- full_join(cc_offenses19, cc_offenses20)
cc_offenses <- full_join(cc_offenses, cc_offenses21)

cc_offenses$date <- str_split(cc_offenses$date, " ", 
                                      simplify = TRUE)[,1] # Get rid of time

dates <- str_split(cc_offenses$date, "/", simplify = TRUE)
month <- dates[,1]
year <- dates[,3]
dates <- tibble(month = month, year = year)
cc_offenses <- tibble(cc_offenses, dates) %>% 
  mutate(date_rept = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format

cc_offenses <- cc_offenses %>% 
  mutate(violent = if_else(
    offense == "Aggravated Assault" | 
      offense == "AGGRAVATED ASSAULT" | 
      offense == "Murder" |
      offense == "Manslaughter" | # Assuming manslaughter is non-negligent; regardless, only 5 offenses
      offense == "Robbery" | 
      offense == "ROBBERY" | 
      offense == "HOME INVASION ROBBERY" | 
      offense == "Homicide" | 
      offense == "SEXUAL BATTERY", 1, 0 # sexual battery is rape in Florida
  )) %>% 
  mutate(property = if_else(
    offense == "Burglary (Business)" | 
      offense == "Burglary (Construction)" | 
      offense == "Burglary (Residence)" | 
      offense == "Burglary (Residential)" |
      offense == "Burglary (Unspecified)" | 
      offense == "Burglary (Vehicle)" | 
      offense == "GRAND THEFT" | 
      offense == "GRAND THEFT - MOTORCYCLE" | 
      offense == "GRAND THEFT - TRUCK/BUSES" |
      offense == "GRAND THEFT AUTOMOBILE" | 
      offense == "PETIT THEFT" |
      offense == "ARSON", 1, 0
  ))

cc_violent <- cc_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

add_dates <- co_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, cc_violent) %>% 
  mutate(n = 0)

cc_violent <- full_join(cc_violent, antijoin) %>% 
  arrange(desc(date))

cc_monthly_violent <- cc_offenses %>% 
    filter(violent == 1) %>% 
  count(my) %>% 
  rename(cc_n = n)

cc_property <- cc_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

add_dates <- co_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, cc_property) %>% 
  mutate(n = 0)

cc_property <- full_join(cc_property, antijoin) %>% 
  arrange(desc(date))

```

```{r tpd-wrangling}
names(tpd_offenses)[2] <- "offense"
names(tpd_offenses)[3] <- "date"

tpd_offenses$date <- str_split(tpd_offenses$date, " ", 
                                      simplify = TRUE)[,1] # Get rid of time

dates <- str_split(tpd_offenses$date, "/", simplify = TRUE)
month <- dates[,1]
year <- dates[,3]
dates <- tibble(month = month, year = year)
tpd_offenses <- tibble(tpd_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format

tpd_offenses$offense <- str_split(tpd_offenses$offense, " - ", simplify = TRUE)[,1] #Simplify offenses

tpd_offenses <- tpd_offenses %>% 
  mutate(violent = if_else(
    offense == "Agg Assault W Deadly Weapon Without Intent To Kill" | 
      offense == "Robbery" | 
      offense == "Sex Asslt" | 
      offense == "Homicide" | 
      offense == "Robbery-Resid" | 
      offense == "Agg Assault" | 
      offense == "Homicide-Neglig-Mansl-Veh", 1, 0
  )) %>% 
  mutate(property = if_else(
    offense == "Burglary" | 
      offense == "Petit Theft 2nd Degree 1st Offense (all Other)" | 
      offense == "Grand 3rd Degree Theft Of Motor Vehicle" | 
      offense == "Petit Theft 2nd Degree 1st Offense (ShopLifting)" | 
      offense == "Petit Theft 1st Degree $100 Less $750 (All Other)" | 
      offense == "Grand 3rd Degree Theft $300 To Less Than $5000 (All Other)" | 
      offense == "Burglary of Structure, Dwelling or Conveyance" | 
      offense == "Petit Theft 1st Degree $100 Less Than $750 (Shoplifting)" | 
      offense == "Grand 3rd Degree Theft $750 To Less Than $5000 (All Other)" | 
      offense == "Burglary With Assault Or Battery" | 
      offense == "Petit Theft 1st Degree $100 Less $300 (All Other)" | 
      offense == "Grand 3rd Degree Theft Of Firearm" | 
      offense == "Petit Theft 2nd Degree 1st Offense (Theft of MV Parts/AC)" | 
      offense == "Grand 3rd Degree Theft $750 To Less Than $5000 (From Building w/ Lawful Access)" | 
      offense == "Petit Theft 2nd Degree 3rd Subsq Offense" | 
      offense == "Petit Theft 1st Degree $100 Less $750 (From MV)" | 
      offense == "Grand 3rd Degree Theft $750 To Less Than $5000" | 
      offense == "Petit Theft 2nd Degree 1st Offense (From Building)" | 
      offense == "Grand Theft (Shoplifting) 20K Dols Less than 100K Dols" | 
      offense == "Grand 3rd DegreeTheft $750 To Less Than $5000 (From Building)" | 
      offense == "Petit Theft 1st Degree $100 Less Than $300 (Shoplifting)" | 
      offense == "Petit Theft 1st Degree $100 Less Than $750 (Larceny From Building)" | 
      offense == "Petit Theft 2nd Degree 2nd Offense (Shoplifting)" | 
      offense == "Grand 3rd Degree Theft $300 To Less Than $5000 (Purse/Bag)" | 
      offense == "Petit Theft 1st Degree $100 Less Than $750 (Pocket-Picking)" | 
      offense == "Petit Theft 2nd Degree 2nd Offense" | 
      offense == "Grand 3rd Degree Theft $300 To Less Than $5000 (Pcket-Picking)" | 
      offense == "Petit Theft 1st Degree $100 Less $300 (From MV)" | 
      offense == "Theft" | 
      offense == "Petit Theft 2nd Degree 1st Offense (From Motor Vehicle)" | 
      offense == "Petit Theft 1st Degree $100 Less $750 (MV Parts Accessories)" | 
      offense == "Petit Theft 2nd Degree 1st Offense" | 
      offense == "Petit Theft 1st Degree $100 Less Than $300 (Theft of Purse)" | 
      offense == "Grand 3rd Degree Theft $5K To Less Than $10K (All Other)" | 
      offense == "Grand 3rd Degree Theft Of Motor Vehicle (By Fraud)" | 
      offense == "Larceny" | 
      offense == "Petit Theft 1st Degree $100 Less Than $750 (Theft of Purse)" | 
      offense == "Petit Theft 2nd Degree 1st Offense (Pocket Picking)" | 
      offense == "Petit Theft 1st Degree $100 Less $300 (MV Parts Accessories)" | 
      offense == "Grand 3rd Degree Theft Of Controlled Substance" | 
      offense == "Grand 3rd Degree Theft $750 To Less Than $5000 (Purse/Bag)" |
      offense == "Grand 3rd Degree Theft Of Dwelling 100 Less 300 Dols" | 
      offense == "Petit Theft 1st Degree $100 Less Than $300 (Pocket-Picking)" | 
      offense == "Grand 3rd Degree Theft $10K To Less Than $20K (All Other)" | 
      offense == "Grand 2nd Degree Theft $20k To Less Than $100k (All Other)" | 
      offense == "Grand Theft Of Firearm" | 
      offense == "Grand 3rd Degree Theft $5K To Less Than $10K (Purse/Bag)" | 
      offense == "Grand Theft 10K Less Than 20K Dols" | 
      offense == "Grand 3rd DegreeTheft $300 To Less Than $5000 (MV Parts Accessories)" | 
      offense == "Petit Theft 2nd Degree 1st Offense (Purse Snatching)" | 
      offense == "Arson" | 
      offense == "Petit Theft 1st Degree 100 Less $750 Dols (False Pret.)" | 
      offense == "Grand 3rd Degree Theft From Dwelling or Curtilage 100 Less 300 Dols" | 
      offense == "Grand 3rd Degree Theft From Posted Construction Site" | 
      offense == "Grand 3rd DegreeTheft $750 To Less Than $5000 (MV Parts Accessories)" | 
      offense == "Petit Theft From Merchant 3rd Subsq Off" | 
      offense == "Petit Theft from Merchant 2nd Off" | 
      offense == "Grand 3rd Degree Theft Of Fire Extinguisher" | 
      offense == "Grand 3rd Degree Theft $300 To Less Than $5000 (Coin Operated Machine)" | 
      offense == "Grand 2nd Degree Theft $5K To Less Than $10K State of Emergency" | 
      offense == "Grand 3rd Degree Theft $300 To Less Than $5000", 1, 0 # stop on page 22 of offenses
  ))

tpd_violent <- tpd_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

add_dates <- co_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, tpd_violent) %>% 
  mutate(n = 0)

tpd_violent <- full_join(tpd_violent, antijoin) %>% 
  arrange(date)

tpd_monthly_violent <- tpd_offenses %>% 
    filter(violent == 1) %>% 
  count(my) %>% 
  rename(tpd_n = n)
tpd_property <- tpd_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)
```

```{r college-station-wrangling}
names(cs_offenses)[3] <- "IBRCode"
names(cs_offenses)[4] <- "temp_date"

cs_offenses <- left_join(cs_offenses, nibrs_conversion, by = "IBRCode")

dates <- str_split(cs_offenses$temp_date, ", ", simplify = TRUE)
year <- dates[,2]
temp_month <- dates[,1]
dates <- tibble(temp_month = temp_month, year = year) %>% 
  mutate(date = paste0(temp_month, ", ", year)) 

dates <- dates %>% 
  mutate(date = parse_date_time(dates$date, orders = "mdy"))

date <- str_split(dates$date, "-", simplify = TRUE)
month <- date[,2]

dates <- tibble(month = month, year = year, date = dates$date)

cs_offenses <- tibble(cs_offenses, dates) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))

cs_offenses <- cs_offenses %>% 
  mutate(violent = ifelse(OFFENSE_NAME == "Aggravated Assault" | 
           OFFENSE_NAME == "Murder & Nonnegligent Manslaughter" | 
           OFFENSE_NAME == "Rape" | 
           OFFENSE_NAME == "Robbery" |
           OFFENSE_NAME == "Sexual Assault With An Object" | 
             OFFENSE_NAME == "Fondling" | 
             OFFENSE_NAME == "Sodomy", 1, 0)) %>% 
  mutate(property = ifelse(OFFENSE_NAME == "All Other Larceny" | 
                             OFFENSE_NAME == "Arson" | 
                             OFFENSE_NAME == "Burglary/Breaking & Entering" |
                             OFFENSE_NAME == "Motor Vehicle Theft" | 
                             OFFENSE_NAME == "Shoplifting" | 
                             OFFENSE_NAME == "Stolen Property Offenses" | 
                             OFFENSE_NAME == "Pocket-picking" |
                             OFFENSE_NAME == "Theft From Building" | 
                             OFFENSE_NAME == "Theft From Coin-Operated Machine or Device" | 
                             OFFENSE_NAME == "Theft From Motor Vehicle" | 
                             OFFENSE_NAME == "Theft of Motor Vehicle Parts or Accessories" | 
                             OFFENSE_NAME == "Destruction/Damage/Vandalism of Property" | 
                             OFFENSE_NAME == "Purse-snatching", 1, 0))



cs_violent <- cs_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE) 

add_dates <- co_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, cs_violent) %>% 
  mutate(n = 0)

cs_violent <- full_join(antijoin, cs_violent) %>% 
  arrange(date)

cs_monthly_violent <- cs_offenses %>% 
    filter(violent == 1) %>% 
  count(my) %>% 
  rename(cs_n = n)

cs_property <- cs_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

```

```{r ny-wrangling}
ny_offenses <- ny_offenses %>% 
  mutate(CMPLNT_FR_DT = mdy(CMPLNT_FR_DT))
ny_offenses <- ny_offenses %>% 
  filter(CMPLNT_FR_DT >= as.Date("2021-01-01"))
ny_offenses_past <- ny_offenses_past %>% 
  mutate(CMPLNT_FR_DT = mdy(CMPLNT_FR_DT))

ny_offenses <- full_join(ny_offenses, ny_offenses_past)

names(ny_offenses)[4] <- "date"
names(ny_offenses)[16] <- "offense"

dates <- str_split(ny_offenses$date, "-", simplify = TRUE)
month <- dates[,2]
year <- dates[,1]
dates <- tibble(month = month, year = year)
ny_offenses <- tibble(ny_offenses, dates) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format

ny_offenses <- ny_offenses %>% 
  mutate(violent = if_else(
    offense == "MURDER & NON-NEGL. MANSLAUGHTER" | 
    offense == "RAPE" | 
    offense == "ROBBERY" | 
    offense == "FELONY ASSAULT", 1, 0
  )) %>% 
  mutate(property = if_else(
    offense == "ARSON" | offense == "BURGLARY" | offense == "GRAND LARCENY" | 
      offense == "GRAND LARCENY OF MOTOR VEHICLE" | offense == "PETIT LARCENY" | 
      offense == "PETIT LARCENY OF MOTOR VEHICLE", 1, 0
  ))

ny_violent <- ny_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE) 

ny_monthly_violent <- ny_offenses %>% 
    filter(violent == 1) %>% 
  count(my) %>% 
  rename(ny_n = n)

ny_property <- ny_offenses %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)
```

```{r mc-wrangling}
mc_offenses19 <- mc_offenses19 %>% 
  select(X3, X14)
names(mc_offenses19)[1] <- "offense"
names(mc_offenses19)[2] <- "date"

mc_offenses20 <- mc_offenses20 %>% 
  select(X4, X15)
names(mc_offenses20)[1] <- "offense"
names(mc_offenses20)[2] <- "date"

mc_offenses <- full_join(mc_offenses19, mc_offenses20)

mc_offenses <- na.omit(mc_offenses)

mc_offenses$date <- str_split(mc_offenses$date, " ", 
                                      simplify = TRUE)[,1] # Get rid of time

dates <- str_split(mc_offenses$date, "/", simplify = TRUE)
month <- dates[,1]
year <- dates[,3]
dates <- tibble(month = month, year = year)
mc_offenses <- tibble(mc_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format

mc_offenses <- mc_offenses %>% 
  mutate(violent = if_else(
    offense == "AGGRAVATED ASSAULT" | 
      offense == "ROBBERY" | 
      offense == "RAPE" | 
      offense == "SODOMY" | 
      offense == "MURDER & NONNEGLIGENT", 1, 0
  ))

mc_violent <- mc_offenses %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-07-01") & date < as.Date("2020-12-31") ~ "2019-20",
    date >= as.Date("2020-07-01") & date < as.Date("2020-12-31") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE) 

add_dates <- co_year_limit %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, mc_violent) %>% 
  mutate(n = 0)

mc_violent <- full_join(antijoin, mc_violent) %>% 
  arrange(date)

mc_monthly_violent <- mc_offenses %>% 
  filter(violent == 1) %>% 
  count(my) %>% 
  mutate(time_period = case_when(
    my >= as.Date("2019-08-01") & my < as.Date("2019-12-31") ~ "2019-20",
    my >= as.Date("2020-08-01") & my < as.Date("2020-12-31") ~ "2020-21")) %>% 
  filter(is.na(time_period) == FALSE)
```

```{r aurora-wrangling}
aurora_offenses <- aurora_offenses %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))
```



```{r uof-wrangling-co}
names(cspd_uof)[4] <- "date"
names(cspd_uof)[5] <- "reason"
names(cspd_uof)[6] <- "force_type"
names(cspd_uof)[7] <- "injury"

year <- str_split(cspd_uof$date, "/", simplify = TRUE)
month <- year[,1]
year <- year[,3]
dates <- tibble(month = month, year = year)

cspd_uof <- tibble(cspd_uof, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))

cspd_uof_analysis <- cspd_uof %>%
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE) 

cspd_uof_monthly <- cspd_uof %>% 
  count(my)

add_dates <- co_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, cspd_uof_analysis) %>% 
  mutate(n = 0)

cspd_uof_analysis <- full_join(antijoin, cspd_uof_analysis) %>% 
  arrange(desc(date))
  

```


```{r uof-wrangling-wa}
names(seattle_uof)[4] <- "date"


seattle_uof$date <- str_split(seattle_uof$date, " ", simplify = TRUE)[,1]
year <- str_split(seattle_uof$date, "/", simplify = TRUE)
month <- year[,1]
year <- year[,3]
dates <- tibble(month = month, year = year)

seattle_uof <- seattle_uof %>% 
  tibble(dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))

seattle_uof_analysis <- seattle_uof %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-06-19") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-06-20") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE) 

seattle_uof_monthly <- seattle_uof %>% 
  count(my)

add_dates <- co_violent %>% 
  select(date, time_period)

antijoin <- anti_join(add_dates, seattle_uof_analysis) %>% 
  mutate(n = 0)

seattle_uof_analysis <- full_join(antijoin, seattle_uof_analysis) %>% 
  arrange(desc(date))
```

### Exploratory Data Analysis (Violent CO Crimes)

Colorado's qualified immunity bill was passed on June 19, 2020, and Section 3 came into effect immediately upon passage. 


```{r violent-plot}
ggplot(daily_violent, aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  labs(title = "Daily Violent Crime Incident Trends in Denver for 5 Years", 
       x = "Date", 
       y = "Number of Violent Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
wa_violent <- wa_offenses %>% 
  filter(offense == "Aggravated Assault" | 
           offense == "Murder & Nonnegligent Manslaughter" | 
           offense == "Rape" | 
           offense == "Robbery" |
           offense == "Sexual Assault With An Object")

daily_violent_wa <- wa_violent %>% 
  filter(date >= as.Date("2016-01-01")) %>% 
  count(date)
```

```{r wa-plot-violent}
ggplot(daily_violent_wa, aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  labs(title = "Daily UCR Violent Crime Incident Trends in Seattle for 5 Years", 
       x = "Date", 
       y = "Number of Violent Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r cspd-violent-plot}
cspd_violent %>% 
  filter(date >= as.Date("2016-01-01")) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  labs(title = "Daily Violent Crime Incident Trends in Colorado Springs for 5 Years", 
       x = "Date", 
       y = "Number of UCR Violent Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```
### Analysis (CO Crimes)

### Synthetic Control Comparison

According to the synthetic control model, these four cities are by far weighted the most heavily in comparing violent crime rates to Denver:


```{r create-weighted-average}
t1 <- co_limited_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_limited_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(jurisdiction = "Denver") %>% 
  select(diff, jurisdiction)

wat1 <- wa_limited_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- wa_limited_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysiswa <- tibble(wat1, wat2) %>% 
  mutate(seattle_diff = (p2 - p1) / sum(p1)) %>% 
  select(seattle_diff)

wat1 <- tx_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- tx_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysistx <- tibble(wat1, wat2) %>% 
  mutate(tx_diff = (p2 - p1) / sum(p1)) %>% 
  select(tx_diff)

wat1 <- fspd_limited_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- fspd_limited_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysisfspd <- tibble(wat1, wat2) %>% 
  mutate(fspd_diff = (p2 - p1) / sum(p1)) %>% 
  select(fspd_diff)

wat1 <- il_limited_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- il_limited_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysisil <- tibble(wat1, wat2) %>% 
  mutate(il_diff = (p2 - p1) / sum(p1)) %>% 
  select(il_diff)

synthetic <- tibble(combined_analysiswa, combined_analysistx, combined_analysisfspd, 
                    combined_analysisil) %>% 
  mutate(diff = seattle_diff * 0.496466442 + tx_diff * 0.004280705 + fspd_diff * 0.487715311 + 
           il_diff * 0.011537542) %>% 
  mutate(jurisdiction = "Synthetic Control")  %>% 
  select(diff, jurisdiction)

combined_synthetic_violent <- full_join(combined_analysis, synthetic)
```

```{r simulate-diff-synthetic}
null_dist <- combined_synthetic_violent %>% 
  specify(diff ~ jurisdiction) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 10000, type = "permute") %>% 
  calculate(stat = "diff in means", 
            order = c("Denver", "Synthetic Control"))

obs_diff <- combined_synthetic_violent %>% 
  specify(diff ~ jurisdiction) %>% 
  calculate(stat = "diff in means", order = c("Denver", "Synthetic Control")) %>% 
  pull()

null_dist %>% 
  filter(stat >= obs_diff) %>% 
  summarise(p_value = n()/nrow(null_dist))

```

Because the p-value of 0.1024 is greater than a reasonable alpha level of 0.01, we fail to reject the null hypothesis. The data does not provide sufficient evidence at the 1% level that Denver's average daily difference in violent crimes between 2020-21 vs 2019-20 is significantly greater than the synthetic control's average daily increase in violent crimes. 

```{r}
ggplot(null_dist, aes(x = stat)) + 
  geom_histogram() + 
  geom_vline(xintercept = obs_diff, lty = 2, color = "red")
```

### Colorado Springs Tests

I ran the same comparison tests using Colorado Springs data.

```{r create-weighted-average-cspd}
t1 <- cspd_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- cspd_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(jurisdiction = "Colorado Springs") %>% 
  select(diff, jurisdiction)

wat1 <- ny_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- ny_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysisny <- tibble(wat1, wat2) %>% 
  mutate(ny_diff = (p2 - p1) / sum(p1)) %>% 
  select(ny_diff)

wat1 <- cc_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- cc_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysiscc <- tibble(wat1, wat2) %>% 
  mutate(cc_diff = (p2 - p1) / sum(p1)) %>% 
  select(cc_diff)

wat1 <- tpd_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- tpd_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysistpd <- tibble(wat1, wat2) %>% 
  mutate(tpd_diff = (p2 - p1) / sum(p1)) %>% 
  select(tpd_diff)

wat1 <- cs_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- cs_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysiscs <- tibble(wat1, wat2) %>% 
  mutate(cs_diff = (p2 - p1) / sum(p1)) %>% 
  select(cs_diff)

synthetic <- tibble(combined_analysisny, combined_analysiscs, combined_analysistpd, 
                    combined_analysiscc) %>% 
  mutate(diff = ny_diff * 0.8749666 + cc_diff * 0.1250270 + tpd_diff * 0.000005 + 
           cs_diff * 0.0000009) %>% 
  mutate(jurisdiction = "Synthetic Control")  %>% 
  select(diff, jurisdiction)

combined_synthetic_violent_cspd <- full_join(combined_analysis, synthetic)
```

```{r simulate-diff-synthetic}
null_dist <- combined_synthetic_violent_cspd %>% 
  specify(diff ~ jurisdiction) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 10000, type = "permute") %>% 
  calculate(stat = "diff in means", 
            order = c("Colorado Springs", "Synthetic Control"))

obs_diff <- combined_synthetic_violent_cspd %>% 
  specify(diff ~ jurisdiction) %>% 
  calculate(stat = "diff in means", order = c("Colorado Springs", "Synthetic Control")) %>% 
  pull()

null_dist %>% 
  filter(stat >= obs_diff) %>% 
  summarise(p_value = n()/nrow(null_dist))

```

```{r}
ggplot(null_dist, aes(x = stat)) + 
  geom_histogram() + 
  geom_vline(xintercept = obs_diff, lty = 2, color = "red")
```

```{r create-synthetic-control-graph-cspd-raw-numbers}
synthetic_control_graph_cspd <- full_join(cc_monthly_violent, ny_monthly_violent, 
                                     by = "my")
synthetic_control_graph_cspd <- full_join(synthetic_control_graph_cspd, cs_monthly_violent, 
                                     by = "my")
synthetic_control_graph_cspd <- full_join(synthetic_control_graph_cspd, tpd_monthly_violent, 
                                     by = "my")

sum_cspd <- cspd_monthly_violent %>% 
  filter(my >= as.Date("2019-01-01") & my <= as.Date("2021-06-01")) %>% 
  summarise(sum = sum(n)) %>% 
  pull()

synthetic_control_graph_cspd <- synthetic_control_graph_cspd %>% 
  filter(my >= as.Date("2019-01-01") & my <= as.Date("2021-06-01")) %>% 
  mutate(n = ((ny_n / sum(ny_n)) * 0.8749666 + (cc_n / sum(cc_n)) * 0.1250270
         + (cs_n / sum(cs_n)) * 0.0000009 + 
           (tpd_n / sum(tpd_n)) * 0.000005) * sum_cspd) %>% 
  mutate(jurisdiction = "Synthetic Control")

synthetic_control_graph_cspd <- cspd_monthly_violent %>% 
  filter(my >= as.Date("2019-01-01") & my <= as.Date("2021-06-01")) %>% 
  mutate(jurisdiction = "Colorado Springs") %>% 
  full_join(synthetic_control_graph_cspd) %>% 
  select(my, n, jurisdiction)

ggplot(synthetic_control_graph_cspd, aes(x = my, y = n, color = jurisdiction)) + 
  geom_line() + 
  ylim(0, 600) +
  geom_vline(xintercept = mdy("06-19-2020"), lty = 2, color = "red") + 
  labs(title = "Colorado Springs vs Control Monthly Violent Crime Numbers", 
       x = "Date", 
       y = "Number of Reported Violent Crime Incidents", 
       color = "Jurisdiction") +
  theme(text = element_text(size = 9))
```



```{r cspd-violent-comparison-setup}
cspd_violent_period <- cspd %>% 
  filter(violent == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

t1 <- cspd_violent_period %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- cspd_violent_period %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Colorado Springs")

combined_mn <- full_join(combined_analysis, combined_analysismn)
combined_wa <- full_join(combined_analysis, combined_analysiswa)
```

```{r}
combined_mn %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Colorado Springs", "Minneapolis"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of 0.00271 is less than our preset alpha level of 0.01, we reject the null hypothesis. The data provides sufficient evidence to indicate that the proportional average daily increase in crime in Minneapolis is different from the proportional average daily increase in crime in Colorado Springs between the two time periods. In addition, because the confidence interval is entirely negative and does not include 0, we are 95% confident that the true proportional average daily increase in crime in Minneapolis is greater than the same proportional average daily increase in crime in Colorado Springs.
```{r}
combined_wa %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Colorado Springs", "Washington"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of 0.104 is greater than the alpha level of 0.01, we fail to reject the null hypothesis. 

## Exploratory Data Analysis (CO Property Crimes)

```{r prop-crime-wa-plot}
wa_property %>% 
  filter(date >= as.Date("2016-01-01")) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  labs(title = "Daily Property Crime Incident Trends in Seattle for 5 Years", 
       x = "Date", 
       y = "Number of UCR Property Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r prop-crime-denver-plot}
co_property_totals %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  labs(title = "Daily Property Crime Incident Trends in Denver for 5 Years", 
       x = "Date", 
       y = "Number of UCR Property Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```
Based on this plot, it appears that there was an irregular spike in property crimes that began roughly in February or March of 2020 and continued building until the beginning of 2021 (where it began to fall). This spike also did not appear to be matched in other jurisdictions (Minneapolis and Seattle). 

Strangely, however, the same trend was not found in Colorado Springs, where the number of property crimes may have slightly decreased instead of increasing.

```{r cspd-prop-plot}
cspd_property %>% 
  filter(date >= as.Date("2016-01-01")) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  labs(title = "Daily Property Crime Incident Trends in Colorado Springs for 5 Years", 
       x = "Date", 
       y = "Number of UCR Property Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```



### Property Crimes Analysis

I began by running a two-sample t-test on the average proportional daily increase/decrease in property crime between Minneapolis and Denver. 

$H_0: \mu_{Denver} = \mu_{Minneapolis}$. The true mean daily proportional difference in number of property offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is equal to the true mean daily proportional difference in number of property offenses between the two time periods in Minneapolis

$H_A: \mu_Denver} ≠ \mu_{Minneapolis}$. The true mean daily proportional difference in number of property offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is not equal to the true mean daily proportional difference in number of property offenses between the two time periods in Minneapolis

$\alpha$ = 0.01

```{r co-prop-crime-mn-comp-setup}
period_mn <- mn_property_totals %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

antijoin <- anti_join(period3, period_mn, by = "date")

antijoin <- antijoin %>% 
  select(date, time_period) %>% 
  mutate(n = 0)

period_mn <- full_join(period_mn, antijoin) %>% 
  arrange(date)



t1 <- co_property_totals %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_property_totals %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- period_mn %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- period_mn %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysismn <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Minneapolis")

combined_mn <- full_join(combined_analysis, combined_analysismn)
```

```{r}
combined_analysismn %>% 
  summarise(sum = sum(p1))
combined_analysis %>% 
  summarise(sum = sum(p1))
```


```{r mn-property-test}
combined_mn %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Minneapolis"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because our p-value of nearly 0 is lower than our preset alpha level of 0.01, we reject the null hypothesis. The data provides sufficient evidence to indicate that the true mean daily proportional difference in number of property offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO was not equal to the true mean daily proportional difference in number of property offenses between the two time periods in Minneapolis. In addition, we are 95% confident that the true average daily proportional increase in property crime from June 2019 to May 2020 in Denver to June 2020 to May 2021 in Denver is between 0.00122 to 0.00151 greater than the true average daily proportional increase in property crime between the two periods in Minneapolis. In other words, we are 95% confident that the true average daily increase in property crime in Denver is between 32.096 to 39.786 property offenses greater than the true average daily increase in property crime in Minneapolis, adjusting for proportionate differences between the two.

```{r mn-property-test}
combined_mn %>% 
  t_test(abs_diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Minneapolis"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Similarly, the two-sample t-test on absolute differences indicates that Denver had a greater absolute increase in daily average property crimes compared to Minneapolis by a significant margin (31.149 to 37.876 property offenses/day).

I ran the same test with Seattle data.

```{r}
wat1 <- wa_property %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- wa_property %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysistx <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Seattle")

t1 <- co_property_totals %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_property_totals %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Denver")

combined_wa <- full_join(combined_analysis, combined_analysistx)
```

```{r}
combined_wa %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Seattle"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Similarly, the test indicated an extremely low p-value of nearly 0 and a confidence interval with high positive numbers, indicating that Denver's average daily proportional increase in property crime was well above Seattle's increase in property crime between the two periods. Thus, lurking variables shared between Seattle and Denver or Minneapolis and Denver likely do not explain the rapid increase in property crimes between the two periods.

#### Houston Comparison

I ran the same property crime analysis to compare Houston and Denver property crimes.

```{r houston-prop-crime-comparison}
wat1 <- tx_property %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- tx_property %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysistx <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Houston")

t1 <- co_limited_property %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_limited_property %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Denver")

combined_tx <- full_join(combined_analysis, combined_analysistx)


```

```{r}
combined_tx %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Houston"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of nearly 0 is far less than a reasonable alpha level of 0.01, we reject the null hypothesis. The data provides sufficient evidence to indicate that Denver's increase in property crime from the June 2019-20 period to the June 2020-21 period was significantly different from Houston's increase in property crime. The confidence interval further indicates that Denver's average proportional daily increase in property crime was significantly greater than Houston's increase.


### Fort Smith Comparison

```{r combine-analysis-fspd}
t1 <- co_property_totals %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_property_totals %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- fspd_property %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- fspd_property %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysisfspd <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Fort Smith")

combined <- full_join(combined_analysis, combined_analysisfspd)
```
```{r fspd-t-test}
combined %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Fort Smith"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

#### Synthetic Control Comparison

Austin, Texas - 0.6935988
Champaign - 0.2188792
Seattle - 0.08747524
Fort Smith - 0.00004654831


```{r create-weighted-average-property}
t1 <- co_property_totals %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_property_totals %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(jurisdiction = "Denver") %>% 
  select(diff, jurisdiction)

wat1 <- wa_property %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- wa_property %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysiswa <- tibble(wat1, wat2) %>% 
  mutate(seattle_diff = (p2 - p1) / sum(p1)) %>% 
  select(seattle_diff)

wat1 <- austin_property %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- austin_property %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysistx <- tibble(wat1, wat2) %>% 
  mutate(tx_diff = (p2 - p1) / sum(p1)) %>% 
  select(tx_diff)

wat1 <- fspd_property %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- fspd_property %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysisfspd <- tibble(wat1, wat2) %>% 
  mutate(fspd_diff = (p2 - p1) / sum(p1)) %>% 
  select(fspd_diff)

wat1 <- il_property %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- il_property %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysisil <- tibble(wat1, wat2) %>% 
  mutate(il_diff = (p2 - p1) / sum(p1)) %>% 
  select(il_diff)

synthetic <- tibble(combined_analysiswa, combined_analysistx, combined_analysisfspd, 
                    combined_analysisil) %>% 
  mutate(diff = seattle_diff * 0.08747524 + tx_diff * 0.6935988 + fspd_diff * 0.00004654831 + 
           il_diff * 0.2188792) %>% 
  mutate(jurisdiction = "Synthetic Control")  %>% 
  select(diff, jurisdiction)

combined_synthetic_property <- full_join(combined_analysis, synthetic)
```

```{r simulate-diff-synthetic}
null_dist2 <- combined_synthetic %>% 
  specify(diff ~ jurisdiction) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 10000, type = "permute") %>% 
  calculate(stat = "diff in means", 
            order = c("Denver", "Synthetic Control"))

obs_diff <- combined_synthetic %>% 
  specify(diff ~ jurisdiction) %>% 
  calculate(stat = "diff in means", order = c("Denver", "Synthetic Control")) %>% 
  pull()

null_dist2 %>% 
  filter(stat >= obs_diff) %>% 
  summarise(p_value = n()/nrow(null_dist))

```

Because the p-value of 0 is far less than a reasonable alpha level of 0.01, we reject the null hypothesis. The data provides sufficient evidence to indicate that Denver's average daily proportional increase in property crime after the passage of qualified immunity was significantly greater than control cities' increase in property crime over the same time period.

```{r}
ggplot(null_dist2, aes(x = stat)) + 
  geom_histogram() + 
  geom_vline(xintercept = obs_diff, lty = 2, color = "red")
```

#### Colorado Springs Property Crime Tests

Colorado Springs is another populous jurisdiction in Colorado and was also influenced by the elimination of qualified immunity through legislation. If the same trend can be found in Colorado Springs, the data would provide strong evidence that a factor specific to populous cities in Colorado as a whole may be influencing the spike in property crime rates.

```{r cspd-prop-crime-mn}
cspd_property_period <- cspd %>% 
  filter(property == 1) %>% 
  count(date) %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

t1 <- cspd_property_period %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- cspd_property_period %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Colorado Springs")

combined_mn <- full_join(combined_analysis, combined_analysismn)
combined_wa <- full_join(combined_analysis, combined_analysiswa)

```

```{r test-cspd-mn-prop-diff}
combined_mn %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Colorado Springs", "Minneapolis"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of 0.209 is far above a reasonable alpha level of 0.01, we fail to reject the null hypothesis. The data does not provide sufficient evidence to indicate that the average proportional daily increase in property crime in Minneapolis from the June 2019 to May 2020 time period to June 2020 to May 2021 time period was significantly different from the average proportional daily increase in property crime in Colorado Springs over the same time period. 

```{r test-cspd-mn-abs-diff}
combined_mn %>% 
  t_test(abs_diff ~ jurisdiction, 
         mu = 0, 
         order = c("Colorado Springs", "Minneapolis"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

When comparing absolute differences, the confidence interval for the absolute average daily differences in crime is much more reasonable compared to the confdience interval comparing Denver with Minneapolis (-1.366 property crimes to 4.390 property crimes).


```{r test-cspd-wa-prop-diff}
combined_wa %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Colorado Springs", "Seattle"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of nearly 0 is less than a reasonable alpha level of 0.01, we reject the null hypothesis. The data provides sufficient evidence to indicate that the average daily proportional difference in property crime between the two time periods for Seattle is different from the average daily proportional difference in property crime between the two time periods for Colorado Springs. However, because the confidence interval is all negative, the data provides evidence at a 95% level that Seattle's average daily proportional increase in property crime was significantly greater than the average daily proportional increase in property crime in Colorado Springs.

```{r test-cspd-wa-abs-diff}
combined_wa %>% 
  t_test(abs_diff ~ jurisdiction, 
         mu = 0, 
         order = c("Colorado Springs", "Seattle"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

In terms of absolute differences, we are 95% confident that the true average daily number of property crimes increased by between 7.026 to 13.301 crimes more in Seattle than the increase between the two time periods in Colorado Springs.

## Civilian Shootings

### CO Use of Force EDA

```{r co-uof}
ggplot(cspd_uof_monthly, aes(x = my, y = n)) +
  geom_bar(stat = "identity") + 
  labs(title = "Use of Force Incident Trends in Colorado Springs", 
       x = "Date", 
       y = "Number of Monthly Use of Force Incidents") + 
  theme(legend.position = "none") +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
ggplot(seattle_uof_monthly, aes(x = my, y = n)) +
  geom_bar(stat = "identity") + 
  labs(title = "Use of Force Incident Trends in Seattle", 
       x = "Date", 
       y = "Number of Monthly Use of Force Incidents") + 
  theme(legend.position = "none") +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

### CO Use of Force Analysis

```{r}
t1 <- cspd_uof_analysis %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- cspd_uof_analysis %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Colorado Springs")

wat1 <- seattle_uof_analysis %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- seattle_uof_analysis %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysiswa <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Seattle")

combined <- full_join(combined_analysis, combined_analysiswa)
```

```{r}
combined %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Colorado Springs", "Seattle"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

```{r}
combined %>% 
  group_by(jurisdiction) %>% 
  summarise(mean = mean(diff), 
            mean2 = mean(abs_diff))
```


```{r diagnostics-to-npap-graph}
wat1 <- wa_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- wa_violent %>% 
  filter(time_period == "2020-21") %>% 
  rename("p2" = n)

combined_analysiswa <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(pop_diff = (p2 - p1) / 753675 * 100000) %>% 
  mutate(jurisdiction = "Seattle") %>% 
  select(date, diff, pop_diff, jurisdiction)

wat1 <- tx_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- tx_violent %>% 
  filter(time_period == "2020-21") %>% 
  rename("p2" = n)

combined_analysistx <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(pop_diff = (p2 - p1) / 2320268 * 100000) %>% 
  mutate(jurisdiction = "Houston") %>% 
  select(date, diff, pop_diff, jurisdiction)

wat1 <- fspd_violent %>%
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n) 

wat2 <- fspd_violent %>% 
  filter(time_period == "2020-21") %>% 
  rename("p2" = n)

combined_analysisfspd <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(pop_diff = (p2 - p1) / 87891 * 100000) %>% 
  mutate(jurisdiction = "Fort Smith") %>% 
  select(date, diff, pop_diff, jurisdiction)

wat1 <- il_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- il_violent %>% 
  filter(time_period == "2020-21") %>% 
  rename("p2" = n)

combined_analysisil <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(pop_diff = (p2 - p1) / 88909 * 100000) %>% 
  mutate(jurisdiction = "Champaign") %>% 
  select(date, diff, pop_diff, jurisdiction)

diagnostics <- full_join(combined_analysiswa, combined_analysisfspd) %>% 
  full_join(combined_analysistx) %>% 
  full_join(combined_analysisil) 

ggplot(diagnostics, aes(x = diff, fill = jurisdiction)) + 
  geom_density(alpha = 0.4) 
```

```{r}
austin_offenses %>% 
  summarise(max = max(date))
```


## Citations

Seattle Data: https://data.seattle.gov/Public-Safety/SPD-Crime-Data-2008-Present/tazs-3rd5
Denver Data: https://www.denvergov.org/opendata/dataset/city-and-county-of-denver-crime
Houston Data: https://www.houstontx.gov/police/cs/Monthly_Crime_Data_by_Street_and_Police_Beat.htm


### Past Work

I considered several different analysis techniques to gain some insight into whether the adoption of qualified immunity coincided with increases in crime, but I concluded that most analysis techniques need more data (for instance, one analysis technique would be to construct a model where the changes in months could account for seasonal crime changes, but each month coefficient would only have a sample of 5 to generate conclusions from, not nearly large enough to make a good model). Since we are using census level data, I calculated the total number of non-traffic crimes (vehicular assault included) since qualified immunity was passed until May 21 and then compared that figure to a similar time period with the same number of days from the previous year (2019-20).


```{r co-2020-2021-crimes}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2020-06-19")) %>% 
  nrow() #337 day time period
```

```{r co-summary-stats}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-21")) %>% 
  nrow() #Slightly different time interval to compensate for the leap day. Placed an extra day in the summer which slightly skews the number of crimes to be seasonally greater.
```

Based on the 9-month time interval, it appears that qualified immunity did coincide with an increase in crimes. In particular, from the day that qualified immunity has passed until May 21, the total number of non-traffic offenses was 6773 offenses greater than the total number of non-traffic offenses from the similar time interval between 2019 and 2020.

I compared the differences in crimes between time intervals in the past to determine if a 6773-offense difference between yearly non-traffic crime incidents was unusual.

```{r co-summary-stats}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-21")) %>% 
  nrow() #2019-20
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2018-06-19") & date <= as.Date("2019-05-21")) %>% 
  nrow() #2018-19
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2017-06-19") & date <= as.Date("2018-05-21")) %>% 
  nrow() #2017-18
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2016-06-19") & date <= as.Date("2017-05-21")) %>% 
  nrow() #2016-17

```

The most that crime numbers differed within one year between similar time intervals in the past is 2142 non-traffic offenses between the June-May time intervals from 2016-17 and from 2017-18. The data strongly suggests that the 6773-offense jump between the May-June time intervals before qualified immunity and after qualified immunity is irregularly large (more than 3x the last greatest crime jump in the last 5 years). Based on the data, it appears that the passage of qualified immunity coincided with an irregularly large jump in non-traffic offenses.

I decided to statistically test the above conclusions using a 2-sample t-test comparing the mean daily offenses from the June 2020-May 2021 time period compared to the June 2019-May 2020 time period.

$H_0: \mu_{2020-21} = \mu_{2019-20}$. The true mean daily number of non-traffic offenses in Denver, Colorado for the June 2020-May 2021 time period is equal to the true mean daily number of non-traffic offenses in Denver, CO for the June 2019-May 2020 time period.

$H_A: \mu_{2020-21} > \mu_{2019-20}$. The true mean daily number of non-traffic offenses for the June 2020-May 2021 time period in Denver, CO is greater than the true mean daily number of non-traffic offenses in Denver, CO for the June 2019-May 2020 time period.

$\alpha$ = 0.01

```{r wrangling-test-offenses}
period <- daily_totals %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)


period2 <- daily_totals %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") |
      date >= as.Date("2018-06-19") & date < as.Date("2019-05-21") |
      date >= as.Date("2017-06-19") & date < as.Date("2018-05-21") |
      date >= as.Date("2016-06-19") & date < as.Date("2017-05-21") ~ "before_qi",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "after_qi"
  )) %>% 
  filter(is.na(time_period) == FALSE)
```

```{r t-test-limited}
period %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("2020-21", "2019-20"), 
         alternative = "greater", 
         conf_int = TRUE, conf_level = 0.95)
```

With a p-value of roughly 0 less than the preset alpha level of 0.01, I reject the null hypothesis. The data provides sufficient evidence to indicate that the true mean daily number of reported non-traffic criminal offenses in Denver, CO from the June 2020 to May 2021 time period is greater than the true mean daily number of reported non-traffic criminal offenses from June 2019 to May 2020 in Denver, CO. 

```{r conf-int}
period %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("2020-21", "2019-20"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

In particular, based on this 95% confidence interval, the true mean daily number of non-traffic criminal offenses that occurred in Denver, CO from June 2020 to May 2021 is about 17.008 to 24.391 offenses greater than the true mean daily number of non-traffic criminal offenses that occurred in Denver, CO from June 2019 to May 2020.

I repeated the same t-test but incorporated data from June-May time periods from the past 5 years to account for yearly variations in crime.

```{r t-test-5-years}
period2 %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("after_qi", "before_qi"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

With a p-value of roughly 0 which is well below a reasonable alpha level of 0.01, the data provides sufficient evidence to indicate that the true mean daily number of non-traffic crimes in Denver, CO from June 2020 to May 2021 is greater than the true mean daily number of non-traffic crimes in those same time periods from 2016-2020 in Denver, CO.
```{r}
obs_diff <- period %>% 
  specify(n ~ time_period) %>% 
  calculate(stat = "diff in means", 
            order = c("2020-21", "2019-20"))
```

These two-sample t-tests indicate that the passage of qualified immunity coincided with a statistically and practically significant increase in average daily crimes in Denver, CO. The above t-tests decrease the possibility that the data collected from Denver stems merely from random chance. Our analysis, however, cannot rule out a host of other lurking variables that could explain the leap in crime between the 2019-20 time interval and 2020-21 time interval. The passage of qualified immunity in Denver also coincided with George Floyd protests, decreased trust in police, and increased violence which would all contribute to increased crime figures. The only way to attempt to eliminate these other lurking variables is to compare the leap in crime in Denver, CO with cities with similar crime dynamics that did not pass qualified immunity reform.

Before doing that, I ran the same analysis but with a specific focus on violent crimes as opposed to all non-traffic offenses.

$H_0: \mu_{2020-21} = \mu_{2019-20}$. The mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is equal to the true mean daily number of violent offenses in Denver, CO from June 2019 to May 2020.

$H_A: \mu_{2020-21} > \mu_{2019-20}$. The mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is greater than the true mean daily number of violent offenses in Denver, CO from June 2019 to May 2020.

$\alpha$ = 0.01

```{r violent-wrangling}
period3 <- daily_violent %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)


period4 <- daily_violent %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") |
      date >= as.Date("2018-06-19") & date < as.Date("2019-05-21") |
      date >= as.Date("2017-06-19") & date < as.Date("2018-05-21") |
      date >= as.Date("2016-06-19") & date < as.Date("2017-05-21") ~ "before_qi",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "after_qi"
  )) %>% 
  filter(is.na(time_period) == FALSE)
```

```{r co-violent-t-test}
period3 %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("2020-21", "2019-20"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of 0.001 is smaller than the preset alpha level of 0.01, I reject the null hypothesis. The data provides sufficient evidence to indicate that the true mean daily number of violent offenses from June 2020 to May 2021 is greater than the true mean daily number of violent offenses from June 2019 to May 2020.

$H_0: \mu_{2020-21} = \mu_{2016-20}$. The mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is equal to the true mean daily number of violent offenses in Denver, CO in the same segmented time periods from June 2016 to May 2020.

$H_A: \mu_{2020-21} > \mu_{2016-20}$. The mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is greater than the true mean daily number of violent offenses in Denver, CO in the same segmented time periods from June 2016 to May 2020.

$\alpha$ = 0.01

```{r expanded-co-violent-t-test}
period4 %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("after_qi", "before_qi"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of roughly 0 is less than the preset alpha level of 0.05, I reject the null hypothesis. The data provides sufficient evidence to indicate that the true mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is greater than the true mean daily number of violent offenses in Denver, CO in the same segmented time periods from June 2016 to May 2020.

### Overall Conclusions
The passage of qualified immunity almost certainly coincided with a sustained increase in the average daily number of violent criminal and non-traffic offenses when compared with previous years. It is extremely unlikely that this increase resulted purely from chance (as proven by the t-tests above). The difference between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period is also practically significant with between 14 and 20 more non-traffic offenses being reported to the police on average every day in the June 2020 to May 2021 time period. However, my analysis cannot rule out a series of lurking variables that could explain the increase in crime during this time period. After conducting significant research, I determined that Seattle, WA possesses similar crime dynamics and demographic information (such as population and violent crime rates) to Denver, CO and could serve as a control in this study.

### Seattle Comparison

I will first calculate a confidence interval for the increase in violent crimes in Seattle, WA from the same time periods between June 2019 to May 2020 and June 2020 to May 2021. I will then convert the raw offense numbers to proportionate increases from the 2019-20 time period in Seattle and use the proportionate increases to determine if the confidence interval increases in Denver, CO had similar increases in violent crime numbers.


```{r co-violent-t-test}
wa_violent %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("2020-21", "2019-20"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```


```{r}
wa_violent %>% 
  group_by(time_period) %>% 
  summarise(mean = mean(n))
```

```{r}

0.02465887 / 12.02381
1.225341 / 12.02381

```

We are 95% confident that the true mean number of Seattle violent offenses increased by between 0.205% to 10.191% from June 2020 to May 2021 compared to June 2019 to May 2020. 

```{r}
co_violent %>% 
  group_by(time_period) %>% 
  summarise(mean = mean(n))
```

Applying the percentage confidence interval from Seattle to Denver, taking means from both time periods in Denver as given, there does not appear to be a statistically significant difference between the two city's increases in violent crime. When we apply the percentage confidence interval using Seattle data, we find that the 95% confidence interval for the average daily number of violent crimes between June 2020 and May 2021 to be between 12.812 violent offenses per day and 14.089 violent offenses/day. The mean presented in the data is 13.908 violent offenses per day, which is well within the confidence interval from Seattle. Thus, the data seems to suggest that increases in violent crime in Denver may have been caused by other lurking variables unrelated to qualified immunity reform.

Outside of the above percentage confidence interval, I used a two-sample t-test to compare the 2019-2020 and 2020-21 differences in daily violent crime numbers between Seattle and Denver. I created two new `combined_analysis` data frames that corresponded the daily numbers from June 2019 to May 2020 with the daily numbers from June 2020 to MAy 2021 in each jurisdiction and took the difference between the post-QI reform period from the pre-QI reform period. I then divided the difference by the total number of violent offenses in the 2019-20 period to proportionally standardize the differences.

$H_0: \mu_{Denver} = \mu_{Seattle}$. The true mean daily proportional difference in number of violent offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is equal to the true mean daily proportional difference in number of violent offenses between the two time periods in Seattle.

$H_A: \mu_{2020-21} ≠ \mu_{2016-20}$. The true mean daily proportional difference in number of violent offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is not equal to the true mean daily proportional difference in number of violent offenses between the two time periods in Seattle.

$\alpha$ = 0.01

```{r combine-analysis}
t1 <- co_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- wa_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- wa_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysiswa <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Seattle")

combined <- full_join(combined_analysis, combined_analysiswa)
```
```{r}
combined %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Seattle"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```


Because the p-value of 0.078 is larger than our preset alpha level of 0.01, we fail to reject the null hypothesis. The data does not provide sufficient evidence to indicate that the true mean daily proportional difference in number of violent offenses between the June 2020 to June 2021 time period compared to the June 2019 to June 2020 time period in Denver, CO is not equal to the true mean daily proportional difference in number of violent offenses between the two time periods in Seattle. Although we cannot conclude that the proportional average daily differences in Denver, CO are only larger than Seattle's by chance, the data does not provide us sufficient evidence to rule out chance as the reason why the number of daily violent offenses is larger than the 2019-20 numbers when compared to the control city of Seattle.

Note, however, that the p-value is not very large either. In a one-sided Denver > Seattle test with an alpha level of 0.05, the p-value would be sufficiently low to reject the null hypothesis.

```{r}
combined %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Seattle"), 
         alternative = "greater", 
         conf_int = TRUE, conf_level = 0.95)
```

I decided to run the same test without proportional standardization to determine if results change.

```{r test-no-standardization}
combined %>% 
  t_test(abs_diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Seattle"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of 0.0777 is greater than a reasonable alpha level of 0.01, we fail to reject the null. The data does not provide sufficient evidence to indicate that the true mean daily difference in number of violent offenses between the June 2020 to June 2021 time period compared to the June 2019 to June 2020 time period in Denver, CO is not equal to the true mean daily difference in number of violent offenses between the two time periods in Seattle. However, once again, the p-value is low enough that a single-sided "greater than" test with an alpha of 0.05 would reject the null hypothesis

I also decided to use bootstrapping to simulate whether the differences could be accounted for by natural variation. Since the CLT conditions are not perfectly met in this circumstance (independence is not met because it is a census as opposed to a random sample and is not less than 10% of the population). This time, I ran a single-sided "greater than" test.

```{r simulate-diff-wa}
null_dist <- combined %>% 
  specify(diff ~ jurisdiction) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 10000, type = "permute") %>% 
  calculate(stat = "diff in means", 
            order = c("Denver", "Seattle"))

obs_diff <- combined %>% 
  specify(diff ~ jurisdiction) %>% 
  calculate(stat = "diff in means", order = c("Denver", "Seattle")) %>% 
  pull()

null_dist %>% 
  filter(stat >= obs_diff) %>% 
  summarise(p_value = n()/nrow(null_dist))

```

Because the p-value of 0.0437 is greater than a reasonable alpha level of 0.01, we fail to reject the null hypothesis. The data does not provide sufficient evidence at the 1% level that Denver's average daily difference in violent crimes between 2020-21 vs 2019-20 is significantly greater than Seattle's average daily increase in violent crimes. However, at the 5% level, the test would reject the null hypothesis.

```{r}
ggplot(null_dist, aes(x = stat)) + 
  geom_histogram() + 
  geom_vline(xintercept = obs_diff, lty = 2, color = "red")
```

### Monthly Seattle-Denver Comparison

I experimented with comparing by month, but unfortunately, the sample size appears to be too small to successfully do it.

```{r combine-analysis-monthly}
t1 <- co_monthly_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_monthly_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- wa_monthly_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- wa_monthly_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysiswa <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Seattle")

combined <- full_join(combined_analysis, combined_analysiswa)
```
```{r}
combined %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Seattle"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.99)
```

### Houston Comparison


```{r combine-analysis}
t1 <- co_limited_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_limited_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- tx_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- tx_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysistx <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Houston")

combined <- full_join(combined_analysis, combined_analysistx)
```
```{r}
combined %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Houston"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```


### Fort Smith Comparison

```{r combine-analysis-fspd}
t1 <- co_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- co_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- fspd_violent %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- fspd_violent %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysisfspd <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1), 
         abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Fort Smith")

combined <- full_join(combined_analysis, combined_analysisfspd)
```
```{r fspd-t-test}
combined %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Fort Smith"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```



### Minneapolis Comparison

I ran the same test but with a different control city - Minneapolis. I calculated the same proportional daily differences in violent crimes between both cities and ran a t-test to determine if the proportional daily differences in violent crimes were different between the two cities.



```{r mn-test-setup}
mn_violent_daily <- mn_violent %>% 
  count(date)

period_mn <- mn_violent_daily %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

names(period_mn)[1] = "date"
antijoin <- anti_join(period3, period_mn, by = "date")

antijoin <- antijoin %>% 
  select(date, time_period) %>% 
  mutate(n = 0)

period_mn <- full_join(period_mn, antijoin) %>% 
  arrange(date)

t1 <- period3 %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- period3 %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- period_mn %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- period_mn %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysismn <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(abs_diff = p2 - p1) %>% 
  mutate(jurisdiction = "Minneapolis")

combined_mn <- full_join(combined_analysis, combined_analysismn)
```

$H_0: \mu_{Denver} = \mu_{Minneapolis}$. The true mean daily proportional difference in number of violent offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is equal to the true mean daily proportional difference in number of violent offenses between the two time periods in Minneapolis

$H_A: \mu_{Denver} ≠ \mu_{Minneapolis}$. The true mean daily proportional difference in number of violent offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is not equal to the true mean daily proportional difference in number of violent offenses between the two time periods in Minneapolis

$\alpha$ = 0.01


```{r mn-t-test}
combined_mn %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Minneapolis"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because our p-value of nearly 0 is less than our alpha level of 0.01, I reject the null hypothesis. The data does provide sufficient evidence to indicate that the true mean daily proportional difference in number of violent offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is not equal to the true mean daily proportional difference in number of violent offenses between the two time periods in Minneapolis. However, when analyzing the confidence interval, it appears that the two-sample t-interval, in fact, concludes the opposite: Minneapolis's average daily proportional increase in violent crime was statistically significantly greater than Denver's average daily proportional increase, given that the confidence interval doesn't include 0 and is entirely negative (the confidence interval indicates the numbers of Denver - Minneapolis, meaning a negative confidence interval indicates that Minneapolis had a greater average daily difference in violent crime). 

This test appears to indicate the possibility of a national trend in violent crime increase or, at least, that other cities that didn't pass QI reform also experienced a daily proportional violent crime increase.

```{r mn-t-test}
combined_mn %>% 
  t_test(abs_diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Minneapolis"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Even in terms of absolute differences, the p-value of 0.0014 is below an alpha level of 0.01, meaning we  reject the null hypothesis. The data does provide significant evidence that Minneapolis' daily average absolute increase in violent crime was not equal to Denver's daily average absolute increase in violent crime between the two periods. Based on the two-sample confidence interval, it appears that Minneapolis had a significantly greater average absolute increase in violent crime compared to Denver's increase.
