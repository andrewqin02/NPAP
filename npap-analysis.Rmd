---
title: "NPAP Analysis"
author: "Andrew Qin"
date: "`r Sys.Date()`"
output: pdf_document
---

### Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages, message = FALSE}
library(tidyverse)
library(knitr)
library(rvest)
library(lubridate)
library(readxl)
```

```{r load-data, message = FALSE}
ct_offenses <- read_csv("data/srs_offenses.csv")
co_offenses <- read_csv("data/crime.csv")
co_shootings <- read_excel("data/MPVDatasetDownload.xlsx")
```

### Wrangling

```{r ct-wrangling}
ct_offenses[is.na(ct_offenses)] = 0 #Convert all NA values to 0

ct_offenses <- ct_offenses %>%  # Mutate new variables and create date
  mutate(date = paste0(month, "-01-", year)) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(season = case_when(
    month == 1 | month == 2 | month == 12 ~ "Winter", 
    month >= 3 & month <=5 ~ "Spring", 
    month >= 6 & month < 9 ~ "Summer", 
    month >= 9 & month < 12 ~ "Fall"
  ))

totals <- ct_offenses %>%  # create totals
  filter(offense == "Grand Total") %>% 
  mutate(clearance_rate = (cleared / number))
```


```{r add-dates}
dates <- str_split(co_offenses$FIRST_OCCURRENCE_DATE, " ", simplify = TRUE)
dates <- dates[,1]
year <- str_split(dates, "/", simplify = TRUE)
month <- year[,1]
year <- year[,3]
dates <- tibble(date = dates, month = month, year = year)
co_offenses <- tibble(co_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))
```

```{r wrangling-shootings}
co_shootings <- co_shootings %>% 
  filter(State == "CO") 
names(co_shootings)[6] <- 'date'

dates <- str_split(co_shootings$date, " ", simplify = TRUE)
year <- str_split(dates, "-", simplify = TRUE)
month <- year[,2]
year <- year[,1]
dates <- tibble(month = month, year = year)
co_shootings <- tibble(co_shootings, dates) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))

```


### Exploratory Data Analysis (CT Crimes)

HB 6004 was passed on July 31, 2020, but the bill text only takes effect for incidents that arise after July 1, 2021 (Section 41). Thus, we cannot determine if the effects of real limitations on qualified immunity include increased crime rates. We can only ascertain whether the mere passage of the bill coincided with increases in crime.

```{r line-graph-2020}

totals %>% 
  filter(year == 2020) %>% 
  ggplot(aes(x = date, y = number)) + 
  geom_line() + 
  geom_point() + 
  labs(title = "2020 Crime Incident Trends in CT", 
       x = "Date", 
       y = "Total Recorded SRS Offenses") + 
  theme(legend.position = "none") + 
  geom_vline(xintercept = as.Date("2020-07-16"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

Based on this line graph, it appears that the passage of HB 6004 coincided with a moderate increase in crimes from July to August. However, the increase soon tapered off from August to December. We expanded the data to include 5 years from 2015 to 2020 to determine if the increase from July to August reflected a coincidental seasonal increase.

```{r line-graph-by-year}
ggplot(totals, aes(x = date, y = number, color = factor(year))) + 
  geom_line() + 
  geom_point() + 
  labs(title = "Crime Incident Trends by Year in CT", 
       x = "Date", 
       y = "Total Recorded SRS Offenses") + 
  theme(legend.position = "none") + 
  geom_vline(xintercept = as.Date("2020-07-15"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

Based on this 5-year graph of offenses, 2020 appears to follow a relatively normal seasonal pattern of increase in crimes during the summer. Especially during the months of May, June, and July, crime offenses tend to increase. Reported offenses sometimes increase more in August and sometimes decrease. The only question is whether the expected increase in SRS reported offenses from July to August is significantly exceeded in 2020.

```{r line-graph2}
ggplot(totals, aes(x = date, y = clearance_rate, color = factor(year))) + 
  geom_line() + 
  geom_point() + 
  labs(title = "Clearance Rate Trends by Year in CT", 
       x = "Date", 
       y = "Clearance Rate") + 
  theme(legend.position = "none")
```

### Exploratory Data Analysis (CO Crimes)

Colorado's qualified immunity bill was passed on June 19, 2020, and Section 3 came into effect immediately upon passage. 

```{r}
daily_totals <- co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  count(date)

monthly_totals <- co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  count(my)

co_totals %>% 
  filter(date >= as.Date("2020-01-01") & date < as.Date("2021-01-01")) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point() + 
  labs(title = "2020 Crime Incident Trends in Denver", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  ylim(100, 275) +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
co_totals %>% 
  filter(date >= as.Date("2019-01-01") & date < as.Date("2020-01-01")) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point() + 
  labs(title = "2019 Crime Incident Trends in Denver", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2019-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
co_totals %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  ylim(150, 300) +
  labs(title = "Daily Crime Incident Trends in Denver for 5 Years", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
monthly_totals %>% 
  filter(my < as.Date("2021/05/01")) %>% 
  ggplot(aes(x = my, y = n)) +
  geom_point() + 
  geom_line() + 
  labs(title = "Monthly Crime Incident Trends in Denver for 5 Years", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

### Analysis (CO Crimes)

I considered several different analysis techniques to gain some insight into whether the adoption of qualified immunity coincided with increases in crime, but I concluded that most analysis techniques need more data (for instance, one analysis technique would be to construct a model where the changes in months could account for seasonal crime changes, but each month coefficient would only have a sample of 5 to generate conclusions from, not nearly large enough to make a good model). Since we are using census level data, I calculated the total number of non-traffic crimes (vehicular assault included) since qualified immunity was passed until May 21 and then compared that figure to a similar time period with the same number of days from the previous year (2019-20).


```{r co-2020-2021-crimes}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2020-06-19")) %>% 
  nrow() #337 day time period
```

```{r co-summary-stats}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-21")) %>% 
  nrow() #Slightly different time interval to compensate for the leap day. Placed an extra day in the summer which slightly skews the number of crimes to be seasonally greater.
```

Based on the 9-month time interval, it appears that qualified immunity did coincide with an increase in crimes. In particular, from the day that qualified immunity has passed until May 21, the total number of non-traffic offenses was 6773 offenses greater than the total number of non-traffic offenses from the similar time interval between 2019 and 2020.

I compared the differences in crimes between time intervals in the past to determine if a 6773-offense difference between yearly non-traffic crime incidents was unusual.

```{r co-summary-stats}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-21")) %>% 
  nrow() #2019-20
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2018-06-19") & date <= as.Date("2019-05-21")) %>% 
  nrow() #2018-19
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2017-06-19") & date <= as.Date("2018-05-21")) %>% 
  nrow() #2017-18
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2016-06-19") & date <= as.Date("2017-05-21")) %>% 
  nrow() #2016-17

```

The most that crime numbers differed within one year between similar time intervals in the past is 2142 non-traffic offenses between the June-May time intervals from 2016-17 and from 2017-18. Of course, our sample size is far too low to make any statistically sound conclusions. However, the data strongly suggests that the 6773-offense jump between the May-June time intervals before qualified immunity and after qualified immunity is irregularly large (more than 3x the last greatest crime jump in the last 5 years). Based on the data, it appears that the passage of qualified immunity coincided with an irregularly large jump in non-traffic offenses.

Our analysis, however, cannot rule out a host of other lurking variables that could explain the leap in crime between the 2019-20 time interval and 2020-21 time interval. The passage of qualified immunity in Denver also coincided with George Floyd protests, decreased trust in police, and increased violence which would all contribute to increased crime figures.

## Civilian Shootings

### CO Fatal Shootings EDA

```{r}
shootings_totals <- co_shootings %>% 
  count(my) 

df <- tibble(my = as.Date("2021-02-01"), n = 0)
shootings_totals <- rbind(shootings_totals, df)
```


```{r}
shootings_totals %>% 
  filter(my >= as.Date("2016-01-01")) %>% 
  ggplot(aes(x = my, y = n)) +
  geom_point() + 
  labs(title = "2013-2021 Monthly Fatal Police Shootings", 
       x = "Date", 
       y = "Number of Fatal Police Shootings") + 
  theme(legend.position = "none") + 
  geom_line() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

### CO Fatal Shootings Analysis

```{r co-2020-2021-crimes}
co_shootings %>% 
  filter(date >= as.Date("2020-06-19")) %>% 
  nrow() # a year minus one month - max goes up to May 19
```


```{r co-summary-stats}
co_shootings %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-18")) %>% 
  nrow() 
```

```{r co-summary-stats}
co_shootings %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-19")) %>% 
  nrow() #2019-20
co_shootings %>% 
  filter(date >= as.Date("2018-06-19") & date <= as.Date("2019-05-19")) %>% 
  nrow() #2018-19
co_shootings %>% 
  filter(date >= as.Date("2017-06-19") & date <= as.Date("2018-05-19")) %>% 
  nrow() #2017-18
co_shootings %>% 
  filter(date >= as.Date("2016-06-19") & date <= as.Date("2017-05-19")) %>% 
  nrow() #2016-17
co_shootings %>% 
  filter(date >= as.Date("2015-06-19") & date < as.Date("2016-05-19")) %>% 
  nrow()
co_shootings %>% 
  filter(date >= as.Date("2014-06-19") & date <= as.Date("2015-05-19")) %>% 
  nrow()
co_shootings %>% 
  filter(date >= as.Date("2013-06-19") & date <= as.Date("2014-05-19")) %>% 
  nrow()

```

Based on these summary statistics, it does appear that qualified immunity coincided with a significant decrease in fatal police shootings. In particular, fatal police shootings decreased by 12 shootings from the June 2019 to May 2020 time period (44) compared to the June 2020 to May 2021 time period (32). When compared to the past 3 years (starting from the 2017-18 time period to now), the number of fatal police shootings had been relatively consistent at around 43-44; the number only dropped in the most recent time interval. However, when analyzing the past 7-8 years, the number of fatal police shootings have reached the lows of 18 in the past, indicating that a number as low as 32 fatal police shootings may not be particularly unusual.
