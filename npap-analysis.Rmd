---
title: "NPAP Analysis"
author: "Andrew Qin"
date: "`r Sys.Date()`"
output: pdf_document
---

### Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages, message = FALSE}
library(tidyverse)
library(knitr)
library(rvest)
library(lubridate)
library(infer)
library(readxl)
set.seed(460)
```

```{r load-data, message = FALSE}
ct_offenses <- read_csv("data/srs_offenses.csv")
co_offenses <- read_csv("data/crime.csv")
wa_offenses <- read_csv("data/SPD_Crime_Data__2008-Present.csv")
mn_offenses18 <- read_csv("data/Police_Incidents_2018_PIMS.csv")
mn_offenses19 <- read_csv("data/Police_Incidents_2019.csv")
mn_offenses20 <- read_csv("data/Police_Incidents_2020.csv")
mn_offenses21 <- read_csv("data/Police_Incidents_2021.csv")

# shootings <- read_excel("data/MPVDatasetDownload.xlsx")
```

### Wrangling

```{r ct-wrangling}
ct_offenses[is.na(ct_offenses)] = 0 #Convert all NA values to 0

ct_offenses <- ct_offenses %>%  # Mutate new variables and create date
  mutate(date = paste0(month, "-01-", year)) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(season = case_when(
    month == 1 | month == 2 | month == 12 ~ "Winter", 
    month >= 3 & month <=5 ~ "Spring", 
    month >= 6 & month < 9 ~ "Summer", 
    month >= 9 & month < 12 ~ "Fall"
  ))

totals <- ct_offenses %>%  # create totals
  filter(offense == "Grand Total") %>% 
  mutate(clearance_rate = (cleared / number))
```


```{r add-dates}
dates <- str_split(co_offenses$FIRST_OCCURRENCE_DATE, " ", simplify = TRUE)
dates <- dates[,1]
year <- str_split(dates, "/", simplify = TRUE)
month <- year[,1]
year <- year[,3]
dates <- tibble(date = dates, month = month, year = year)
co_offenses <- tibble(co_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))
```

```{r add-date-wa}
names(wa_offenses)[3] <- 'date'
names(wa_offenses)[7] <- 'crime_against'
names(wa_offenses)[8] <- 'offense_parent_group'
names(wa_offenses)[9] <- 'offense'
names(wa_offenses)[10] <- 'offense_code'
names(wa_offenses)[6] <- 'group_a_b'

wa_offenses$date <- str_split(wa_offenses$date, " ", simplify = TRUE)[,1] # Get rid of time

dates <- str_split(wa_offenses$date, "/", simplify = TRUE)
month <- dates[,1]
year <- dates[,3]
dates <- tibble(month = month, year = year)
wa_offenses <- tibble(wa_offenses, dates) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format
```


```{r mn-wrangling, message = FALSE}
mn_offenses18 <- mn_offenses18 %>% 
  mutate(precinct = as.character(precinct))
mn_offenses21 <- mn_offenses21 %>% 
  mutate(precinct = as.character(precinct))
mn_offenses <- full_join(mn_offenses18, mn_offenses19)
mn_offenses <- full_join(mn_offenses, mn_offenses20)
mn_offenses <- full_join(mn_offenses, mn_offenses21)

mn_offenses$reportedDate <- str_split(mn_offenses$reportedDate, " ", 
                                      simplify = TRUE)[,1] # Get rid of time

dates <- str_split(mn_offenses$reportedDate, "/", simplify = TRUE)
month <- dates[,2]
year <- dates[,1]
dates <- tibble(month = month, year = year)
mn_offenses <- tibble(mn_offenses, dates) %>% 
  mutate(reportedDate = ymd(reportedDate)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my)) # convert to date format

mn_offenses <- mn_offenses %>% 
  mutate(violent = ifelse(
    UCRCode == "01" | UCRCode == "02" | UCRCode == "03" | UCRCode == "04" |
    description == "ROBBERY INCLUDING AUTO THEFT", 1, 0))

mn_violent <- mn_offenses %>% 
  filter(violent == 1)
```



```{r wrangling-shootings}
names(shootings)[6] <- 'date'

dates <- str_split(shootings$date, " ", simplify = TRUE)
year <- str_split(dates, "-", simplify = TRUE)
month <- year[,2]
year <- year[,1]
dates <- tibble(month = month, year = year)
co_shootings <- tibble(shootings, dates) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))

co_shootings <- shootings 

```



### Exploratory Data Analysis (CT Crimes)

HB 6004 was passed on July 31, 2020, but the bill text only takes effect for incidents that arise after July 1, 2021 (Section 41). Thus, we cannot determine if the effects of real limitations on qualified immunity include increased crime rates. We can only ascertain whether the mere passage of the bill coincided with increases in crime.

```{r line-graph-2020}

totals %>% 
  filter(year == 2020) %>% 
  ggplot(aes(x = date, y = number)) + 
  geom_line() + 
  geom_point() + 
  labs(title = "2020 Crime Incident Trends in CT", 
       x = "Date", 
       y = "Total Recorded SRS Offenses") + 
  theme(legend.position = "none") + 
  geom_vline(xintercept = as.Date("2020-07-16"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

Based on this line graph, it appears that the passage of HB 6004 coincided with a moderate increase in crimes from July to August. However, the increase soon tapered off from August to December. We expanded the data to include 5 years from 2015 to 2020 to determine if the increase from July to August reflected a coincidental seasonal increase.

```{r line-graph-by-year}
ggplot(totals, aes(x = date, y = number, color = factor(year))) + 
  geom_line() + 
  geom_point() + 
  labs(title = "Crime Incident Trends by Year in CT", 
       x = "Date", 
       y = "Total Recorded SRS Offenses") + 
  theme(legend.position = "none") + 
  geom_vline(xintercept = as.Date("2020-07-15"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

Based on this 5-year graph of offenses, 2020 appears to follow a relatively normal seasonal pattern of increase in crimes during the summer. Especially during the months of May, June, and July, crime offenses tend to increase. Reported offenses sometimes increase more in August and sometimes decrease. The only question is whether the expected increase in SRS reported offenses from July to August is significantly exceeded in 2020.

```{r line-graph2}
ggplot(totals, aes(x = date, y = clearance_rate, color = factor(year))) + 
  geom_line() + 
  geom_point() + 
  labs(title = "Clearance Rate Trends by Year in CT", 
       x = "Date", 
       y = "Clearance Rate") + 
  theme(legend.position = "none")
```

### Exploratory Data Analysis (Total CO Crimes)

Colorado's qualified immunity bill was passed on June 19, 2020, and Section 3 came into effect immediately upon passage. 


```{r}
daily_totals <- co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  count(date)

monthly_totals <- co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  mutate(my = as.Date(my)) %>% 
  count(my)

daily_totals %>% 
  filter(date >= as.Date("2020-01-01") & date < as.Date("2021-01-01")) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point() + 
  labs(title = "2020 Crime Incident Trends in Denver", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  ylim(100, 275) +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
daily_totals %>% 
  filter(date >= as.Date("2019-01-01") & date < as.Date("2020-01-01")) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point() + 
  labs(title = "2019 Crime Incident Trends in Denver", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2019-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
daily_totals %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  ylim(150, 300) +
  labs(title = "Daily Crime Incident Trends in Denver for 5 Years", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
monthly_totals %>% 
  filter(my < as.Date("2021/05/01")) %>% 
  ggplot(aes(x = my, y = n)) +
  geom_point() + 
  geom_line() + 
  labs(title = "Monthly Crime Incident Trends in Denver for 5 Years", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r wa-comparison}
daily_totals_wa <- wa_offenses %>% 
  filter(offense_parent_group != "DRIVING UNDER THE INFLUENCE") %>% 
  filter(date >= as.Date("2016-01-01")) %>% 
  count(date)

monthly_totals_wa <- wa_offenses %>% 
  filter(offense_parent_group != "DRIVING UNDER THE INFLUENCE") %>%
  filter(date >= as.Date("2016-01-01")) %>% 
  count(my)
```

```{r wa-graph}
ggplot(daily_totals_wa, aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  ylim(100, 300) +
  labs(title = "Daily Crime Incident Trends in Seattle for 5 Years", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

### Exploratory Data Analysis (Violent CO Crimes)

According to the FBI UCR "violent crime" definition, a violent crime is comprised of four offenses: murder and nonnegligent manslaughter, forcible rape, robbery, and aggravated assault. Crucially, other common violent offenses (extortion, harassment, burglary, statutory rape, kidnapping, etc.) are excluded.

"Aggravated Assault"
Murder & Nonnegligent Manslaughter
Rape
Robbery
Sexual Assault With An Object

```{r}
co_violent <- co_offenses %>%
  filter(OFFENSE_CATEGORY_ID == "aggravated-assault" | 
           OFFENSE_CATEGORY_ID == "murder" | 
           OFFENSE_CATEGORY_ID == "robbery" | 
           OFFENSE_CATEGORY_ID == "sexual-assault") %>% 
  filter(OFFENSE_TYPE_ID != "homicide-negligent")

daily_violent <- co_violent %>% 
  count(date)

monthly_violent <- co_violent %>% 
  count(my)
```

```{r violent-plot}
ggplot(daily_violent, aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  labs(title = "Daily UCR Violent Crime Incident Trends in Denver for 5 Years", 
       x = "Date", 
       y = "Number of Violent Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
co_violent %>% 
  filter(date >= as.Date("2020-06-19")) %>% 
  nrow() #337 day time period
co_violent %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-21")) %>% 
  nrow() #2019-20
co_violent %>% 
  filter(date >= as.Date("2018-06-19") & date <= as.Date("2019-05-21")) %>% 
  nrow() #2018-19
co_violent %>% 
  filter(date >= as.Date("2017-06-19") & date <= as.Date("2018-05-21")) %>% 
  nrow() #2017-18
co_violent %>% 
  filter(date >= as.Date("2016-06-19") & date <= as.Date("2017-05-21")) %>% 
  nrow() #2016-17
```

```{r}
wa_violent %>% 
  filter(date >= as.Date("2020-06-19")) %>% 
  nrow() #337 day time period
wa_violent %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-21")) %>% 
  nrow() #2019-20
wa_violent %>% 
  filter(date >= as.Date("2018-06-19") & date <= as.Date("2019-05-21")) %>% 
  nrow() #2018-19
wa_violent %>% 
  filter(date >= as.Date("2017-06-19") & date <= as.Date("2018-05-21")) %>% 
  nrow() #2017-18
wa_violent %>% 
  filter(date >= as.Date("2016-06-19") & date <= as.Date("2017-05-21")) %>% 
  nrow() #2016-17
```

```{r}
wa_violent <- wa_offenses %>% 
  filter(offense == "Aggravated Assault" | 
           offense == "Murder & Nonnegligent Manslaughter" | 
           offense == "Rape" | 
           offense == "Robbery" |
           offense == "Sexual Assault With An Object")

daily_violent_wa <- wa_violent %>% 
  filter(date >= as.Date("2016-01-01")) %>% 
  count(date)
```

```{r wa-plot-violent}
ggplot(daily_violent_wa, aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  labs(title = "Daily UCR Violent Crime Incident Trends in Seattle for 5 Years", 
       x = "Date", 
       y = "Number of Violent Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```
### Analysis (CO Crimes)

I considered several different analysis techniques to gain some insight into whether the adoption of qualified immunity coincided with increases in crime, but I concluded that most analysis techniques need more data (for instance, one analysis technique would be to construct a model where the changes in months could account for seasonal crime changes, but each month coefficient would only have a sample of 5 to generate conclusions from, not nearly large enough to make a good model). Since we are using census level data, I calculated the total number of non-traffic crimes (vehicular assault included) since qualified immunity was passed until May 21 and then compared that figure to a similar time period with the same number of days from the previous year (2019-20).


```{r co-2020-2021-crimes}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2020-06-19")) %>% 
  nrow() #337 day time period
```

```{r co-summary-stats}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-21")) %>% 
  nrow() #Slightly different time interval to compensate for the leap day. Placed an extra day in the summer which slightly skews the number of crimes to be seasonally greater.
```

Based on the 9-month time interval, it appears that qualified immunity did coincide with an increase in crimes. In particular, from the day that qualified immunity has passed until May 21, the total number of non-traffic offenses was 6773 offenses greater than the total number of non-traffic offenses from the similar time interval between 2019 and 2020.

I compared the differences in crimes between time intervals in the past to determine if a 6773-offense difference between yearly non-traffic crime incidents was unusual.

```{r co-summary-stats}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-21")) %>% 
  nrow() #2019-20
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2018-06-19") & date <= as.Date("2019-05-21")) %>% 
  nrow() #2018-19
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2017-06-19") & date <= as.Date("2018-05-21")) %>% 
  nrow() #2017-18
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2016-06-19") & date <= as.Date("2017-05-21")) %>% 
  nrow() #2016-17

```

The most that crime numbers differed within one year between similar time intervals in the past is 2142 non-traffic offenses between the June-May time intervals from 2016-17 and from 2017-18. The data strongly suggests that the 6773-offense jump between the May-June time intervals before qualified immunity and after qualified immunity is irregularly large (more than 3x the last greatest crime jump in the last 5 years). Based on the data, it appears that the passage of qualified immunity coincided with an irregularly large jump in non-traffic offenses.

I decided to statistically test the above conclusions using a 2-sample t-test comparing the mean daily offenses from the June 2020-May 2021 time period compared to the June 2019-May 2020 time period.

$H_0: \mu_{2020-21} = \mu_{2019-20}$. The true mean daily number of non-traffic offenses in Denver, Colorado for the June 2020-May 2021 time period is equal to the true mean daily number of non-traffic offenses in Denver, CO for the June 2019-May 2020 time period.

$H_A: \mu_{2020-21} > \mu_{2019-20}$. The true mean daily number of non-traffic offenses for the June 2020-May 2021 time period in Denver, CO is greater than the true mean daily number of non-traffic offenses in Denver, CO for the June 2019-May 2020 time period.

$\alpha$ = 0.01

```{r wrangling-test-offenses}
period <- daily_totals %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)


period2 <- daily_totals %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") |
      date >= as.Date("2018-06-19") & date < as.Date("2019-05-21") |
      date >= as.Date("2017-06-19") & date < as.Date("2018-05-21") |
      date >= as.Date("2016-06-19") & date < as.Date("2017-05-21") ~ "before_qi",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "after_qi"
  )) %>% 
  filter(is.na(time_period) == FALSE)
```

```{r t-test-limited}
period %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("2020-21", "2019-20"), 
         alternative = "greater", 
         conf_int = TRUE, conf_level = 0.95)
```

With a p-value of roughly 0 less than the preset alpha level of 0.01, I reject the null hypothesis. The data provides sufficient evidence to indicate that the true mean daily number of reported non-traffic criminal offenses in Denver, CO from the June 2020 to May 2021 time period is greater than the true mean daily number of reported non-traffic criminal offenses from June 2019 to May 2020 in Denver, CO. 

```{r conf-int}
period %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("2020-21", "2019-20"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

In particular, based on this 95% confidence interval, the true mean daily number of non-traffic criminal offenses that occurred in Denver, CO from June 2020 to May 2021 is about 17.008 to 24.391 offenses greater than the true mean daily number of non-traffic criminal offenses that occurred in Denver, CO from June 2019 to May 2020.

I repeated the same t-test but incorporated data from June-May time periods from the past 5 years to account for yearly variations in crime.

```{r t-test-5-years}
period2 %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("after_qi", "before_qi"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

With a p-value of roughly 0 which is well below a reasonable alpha level of 0.01, the data provides sufficient evidence to indicate that the true mean daily number of non-traffic crimes in Denver, CO from June 2020 to May 2021 is greater than the true mean daily number of non-traffic crimes in those same time periods from 2016-2020 in Denver, CO.
```{r}
obs_diff <- period %>% 
  specify(n ~ time_period) %>% 
  calculate(stat = "diff in means", 
            order = c("2020-21", "2019-20"))
```

These two-sample t-tests indicate that the passage of qualified immunity coincided with a statistically and practically significant increase in average daily crimes in Denver, CO. The above t-tests decrease the possibility that the data collected from Denver stems merely from random chance. Our analysis, however, cannot rule out a host of other lurking variables that could explain the leap in crime between the 2019-20 time interval and 2020-21 time interval. The passage of qualified immunity in Denver also coincided with George Floyd protests, decreased trust in police, and increased violence which would all contribute to increased crime figures. The only way to attempt to eliminate these other lurking variables is to compare the leap in crime in Denver, CO with cities with similar crime dynamics that did not pass qualified immunity reform.

Before doing that, I ran the same analysis but with a specific focus on violent crimes as opposed to all non-traffic offenses.

$H_0: \mu_{2020-21} = \mu_{2019-20}$. The mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is equal to the true mean daily number of violent offenses in Denver, CO from June 2019 to May 2020.

$H_A: \mu_{2020-21} > \mu_{2019-20}$. The mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is greater than the true mean daily number of violent offenses in Denver, CO from June 2019 to May 2020.

$\alpha$ = 0.01

```{r violent-wrangling}
period3 <- daily_violent %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)


period4 <- daily_violent %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") |
      date >= as.Date("2018-06-19") & date < as.Date("2019-05-21") |
      date >= as.Date("2017-06-19") & date < as.Date("2018-05-21") |
      date >= as.Date("2016-06-19") & date < as.Date("2017-05-21") ~ "before_qi",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "after_qi"
  )) %>% 
  filter(is.na(time_period) == FALSE)
```

```{r co-violent-t-test}
period3 %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("2020-21", "2019-20"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of 0.001 is smaller than the preset alpha level of 0.01, I reject the null hypothesis. The data provides sufficient evidence to indicate that the true mean daily number of violent offenses from June 2020 to May 2021 is greater than the true mean daily number of violent offenses from June 2019 to May 2020.

$H_0: \mu_{2020-21} = \mu_{2016-20}$. The mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is equal to the true mean daily number of violent offenses in Denver, CO in the same segmented time periods from June 2016 to May 2020.

$H_A: \mu_{2020-21} > \mu_{2016-20}$. The mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is greater than the true mean daily number of violent offenses in Denver, CO in the same segmented time periods from June 2016 to May 2020.

$\alpha$ = 0.01

```{r expanded-co-violent-t-test}
period4 %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("after_qi", "before_qi"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of roughly 0 is less than the preset alpha level of 0.05, I reject the null hypothesis. The data provides sufficient evidence to indicate that the true mean daily number of violent offenses in Denver, CO from June 2020 to May 2021 is greater than the true mean daily number of violent offenses in Denver, CO in the same segmented time periods from June 2016 to May 2020.

### Overall Conclusions
The passage of qualified immunity almost certainly coincided with a sustained increase in the average daily number of violent criminal and non-traffic offenses when compared with previous years. It is extremely unlikely that this increase resulted purely from chance (as proven by the t-tests above). The difference between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period is also practically significant with between 14 and 20 more non-traffic offenses being reported to the police on average every day in the June 2020 to May 2021 time period. However, my analysis cannot rule out a series of lurking variables that could explain the increase in crime during this time period. After conducting significant research, I determined that Seattle, WA possesses similar crime dynamics and demographic information (such as population and violent crime rates) to Denver, CO and could serve as a control in this study.

### Seattle Comparison

I will first calculate a confidence interval for the increase in violent crimes in Seattle, WA from the same time periods between June 2019 to May 2020 and June 2020 to May 2021. I will then convert the raw offense numbers to proportionate increases from the 2019-20 time period in Seattle and use the proportionate increases to determine if the confidence interval increases in Denver, CO had similar increases in violent crime numbers.

```{r}
period_wa <- daily_violent_wa %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") ~ "2019-20",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)


period_wa2 <- daily_violent_wa %>% 
  mutate(time_period = case_when(
    date >= as.Date("2019-06-19") & date < as.Date("2020-05-20") |
      date >= as.Date("2018-06-19") & date < as.Date("2019-05-21") |
      date >= as.Date("2017-06-19") & date < as.Date("2018-05-21") |
      date >= as.Date("2016-06-19") & date < as.Date("2017-05-21") ~ "before_qi",
    date >= as.Date("2020-06-19") & date < as.Date("2021-05-21") ~ "after_qi"
  )) %>% 
  filter(is.na(time_period) == FALSE)
```

```{r co-violent-t-test}
period_wa %>% 
  t_test(n ~ time_period, 
         mu = 0, 
         order = c("2020-21", "2019-20"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

```{r}
period_wa %>% 
  group_by(time_period) %>% 
  summarise(mean = mean(n))
```

```{r}

0.02465887 / 12.02381
1.225341 / 12.02381

```

We are 95% confident that the true mean number of Seattle violent offenses increased by between 0.205% to 10.191% from June 2020 to May 2021 compared to June 2019 to May 2020. 

```{r}
period3 %>% 
  group_by(time_period) %>% 
  summarise(mean = mean(n))
```

Applying the percentage confidence interval from Seattle to Denver, taking means from both time periods in Denver as given, there does not appear to be a statistically significant difference between the two city's increases in violent crime. When we apply the percentage confidence interval using Seattle data, we find that the 95% confidence interval for the average daily number of violent crimes between June 2020 and May 2021 to be between 12.812 violent offenses per day and 14.089 violent offenses/day. The mean presented in the data is 13.908 violent offenses per day, which is well within the confidence interval from Seattle. Thus, the data seems to suggest that increases in violent crime in Denver may have been caused by other lurking variables unrelated to qualified immunity reform.

Outside of the above percentage confidence interval, I used a two-sample t-test to compare the 2019-2020 and 2020-21 differences in daily violent crime numbers between Seattle and Denver. I created two new `combined_analysis` data frames that corresponded the daily numbers from June 2019 to May 2020 with the daily numbers from June 2020 to MAy 2021 in each jurisdiction and took the difference between the post-QI reform period from the pre-QI reform period. I then divided the difference by the total number of violent offenses in the 2019-20 period to proportionally standardize the differences.

$H_0: \mu_{Denver} = \mu_{Seattle}$. The true mean daily proportional difference in number of violent offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is equal to the true mean daily proportional difference in number of violent offenses between the two time periods in Seattle.

$H_A: \mu_{2020-21} ≠ \mu_{2016-20}$. The true mean daily proportional difference in number of violent offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is not equal to the true mean daily proportional difference in number of violent offenses between the two time periods in Seattle.

$\alpha$ = 0.01

```{r combine-analysis}
t1 <- period3 %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- period3 %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- period_wa %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- period_wa %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysiswa <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(jurisdiction = "Washington")

combined <- full_join(combined_analysis, combined_analysiswa)
```
```{r}
combined %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Washington"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of 0.332 is much larger than our preset alpha level of 0.01, we fail to reject the null hypothesis. The data does not provide sufficient evidence to indicate that the true mean daily proportional difference in number of violent offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is not equal to the true mean daily proportional difference in number of violent offenses between the two time periods in Seattle. Although we cannot conclude that the proportional average daily differences in Denver, CO are only larger than Seattle's by chance, the data does not provide us sufficient evidence to rule out chance as the reason why the number of daily violent offenses is larger than the 2019-20 numbers when compared to the control city of Seattle.

I decided to run the same test without proportional standardization to determine if results change.

```{r no-standardization}
t1 <- period3 %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- period3 %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1)) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- period_wa %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- period_wa %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysiswa <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1)) %>% 
  mutate(jurisdiction = "Washington")

combined <- full_join(combined_analysis, combined_analysiswa)
```
```{r test-no-standardization}
combined %>% 
  t_test(diff ~ jurisdiction, 
         mu = 0, 
         order = c("Denver", "Washington"), 
         alternative = "two-sided", 
         conf_int = TRUE, conf_level = 0.95)
```

Because the p-value of 0.278 is greater than a reasonable alpha level of 0.01, we fail to reject the null. The data does not provide sufficient evidence to indicate that the true mean daily difference in number of violent offenses between the June 2020 to May 2021 time period compared to the June 2019 to May 2020 time period in Denver, CO is not equal to the true mean daily difference in number of violent offenses between the two time periods in Seattle.

### Minneapolis Comparison

I ran the same test but with a different control city - Minneapolis.

```{r}
antijoin <- anti_join(period_mn, period3, by = "date")
```



```{r}
mn_violent_daily <- mn_violent %>% 
  count(reportedDate)

period_mn <- mn_violent_daily %>% 
  mutate(time_period = case_when(
    reportedDate >= as.Date("2019-06-19") & reportedDate < as.Date("2020-05-20") ~ "2019-20",
    reportedDate >= as.Date("2020-06-19") & reportedDate < as.Date("2021-05-21") ~ "2020-21"
  )) %>% 
  filter(is.na(time_period) == FALSE)

t1 <- period3 %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)
t2 <- period3 %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysis <- tibble(t1, t2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(jurisdiction = "Denver")

wat1 <- period_mn %>% 
  filter(time_period == "2019-20") %>% 
  select(n) %>% 
  rename("p1" = n)

wat2 <- period_mn %>% 
  filter(time_period == "2020-21") %>% 
  select(n) %>% 
  rename("p2" = n)

combined_analysismn <- tibble(wat1, wat2) %>% 
  mutate(diff = (p2 - p1) / sum(p1)) %>% 
  mutate(jurisdiction = "Minneapolis")

combined_mn <- full_join(combined_analysis, combined_analysismn)
```


## Civilian Shootings

### CO Fatal Shootings EDA

```{r}
shootings_totals <- co_shootings %>% 
  count(my) 

df <- tibble(my = as.Date("2021-02-01"), n = 0)
shootings_totals <- rbind(shootings_totals, df)
```


```{r}
shootings_totals %>% 
  filter(my >= as.Date("2016-01-01")) %>% 
  ggplot(aes(x = my, y = n)) +
  geom_point() + 
  labs(title = "2013-2021 Monthly Fatal Police Shootings", 
       x = "Date", 
       y = "Number of Fatal Police Shootings") + 
  theme(legend.position = "none") + 
  geom_line() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

### CO Fatal Shootings Analysis

```{r co-2020-2021-crimes}
co_shootings %>% 
  filter(date >= as.Date("2020-06-19")) %>% 
  nrow() # a year minus one month - max goes up to May 19
```


```{r co-summary-stats}
co_shootings %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-18")) %>% 
  nrow() 
```

```{r co-summary-stats}
co_shootings %>% 
  filter(date >= as.Date("2019-06-19") & date < as.Date("2020-05-19")) %>% 
  nrow() #2019-20
co_shootings %>% 
  filter(date >= as.Date("2018-06-19") & date <= as.Date("2019-05-19")) %>% 
  nrow() #2018-19
co_shootings %>% 
  filter(date >= as.Date("2017-06-19") & date <= as.Date("2018-05-19")) %>% 
  nrow() #2017-18
co_shootings %>% 
  filter(date >= as.Date("2016-06-19") & date <= as.Date("2017-05-19")) %>% 
  nrow() #2016-17
co_shootings %>% 
  filter(date >= as.Date("2015-06-19") & date < as.Date("2016-05-19")) %>% 
  nrow()
co_shootings %>% 
  filter(date >= as.Date("2014-06-19") & date <= as.Date("2015-05-19")) %>% 
  nrow()
co_shootings %>% 
  filter(date >= as.Date("2013-06-19") & date <= as.Date("2014-05-19")) %>% 
  nrow()

```

Based on these summary statistics, it does appear that qualified immunity coincided with a significant decrease in fatal police shootings. In particular, fatal police shootings decreased by 12 shootings from the June 2019 to May 2020 time period (44) compared to the June 2020 to May 2021 time period (32). When compared to the past 3 years (starting from the 2017-18 time period to now), the number of fatal police shootings had been relatively consistent at around 43-44; the number only dropped in the most recent time interval. However, when analyzing the past 7-8 years, the number of fatal police shootings have reached the lows of 18 in the past, indicating that a number as low as 32 fatal police shootings may not be particularly unusual.
