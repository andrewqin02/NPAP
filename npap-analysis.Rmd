---
title: "NPAP Analysis"
author: "Andrew Qin"
date: "`r Sys.Date()`"
output: pdf_document
---

### Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages, message = FALSE}
library(tidyverse)
library(knitr)
library(rvest)
library(lubridate)
```

```{r load-data, message = FALSE}
ct_offenses <- read_csv("data/srs_offenses.csv")
co_offenses <- read_csv("data/crime.csv")
```

### Wrangling

```{r ct-wrangling}
ct_offenses[is.na(ct_offenses)] = 0 #Convert all NA values to 0

ct_offenses <- ct_offenses %>%  # Mutate new variables and create date
  mutate(date = paste0(month, "-01-", year)) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(season = case_when(
    month == 1 | month == 2 | month == 12 ~ "Winter", 
    month >= 3 & month <=5 ~ "Spring", 
    month >= 6 & month < 9 ~ "Summer", 
    month >= 9 & month < 12 ~ "Fall"
  ))

totals <- ct_offenses %>%  # create totals
  filter(offense == "Grand Total") %>% 
  mutate(clearance_rate = (cleared / number))
```


```{r add-dates}
dates <- str_split(co_offenses$FIRST_OCCURRENCE_DATE, " ", simplify = TRUE)
dates <- dates[,1]
year <- str_split(dates, "/", simplify = TRUE)
month <- year[,1]
year <- year[,3]
dates <- tibble(date = dates, month = month, year = year)
co_offenses <- tibble(co_offenses, dates)
```

```{r convert-date}
co_offenses <- co_offenses %>% 
  mutate(date = mdy(date)) %>% 
  mutate(my = paste0(month, "-01-", year)) %>% 
  mutate(my = mdy(my))
```



### Exploratory Data Analysis (CT Crimes)

HB 6004 was passed on July 31, 2020, but the bill text only takes effect for incidents that arise after July 1, 2021 (Section 41). Thus, we cannot determine if the effects of real limitations on qualified immunity include increased crime rates. We can only ascertain whether the mere passage of the bill coincided with increases in crime.

```{r line-graph-2020}

totals %>% 
  filter(year == 2020) %>% 
  ggplot(aes(x = date, y = number)) + 
  geom_line() + 
  geom_point() + 
  labs(title = "2020 Crime Incident Trends in CT", 
       x = "Date", 
       y = "Total Recorded SRS Offenses") + 
  theme(legend.position = "none") + 
  geom_vline(xintercept = as.Date("2020-07-16"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

Based on this line graph, it appears that the passage of HB 6004 coincided with a moderate increase in crimes from July to August. However, the increase soon tapered off from August to December. We expanded the data to include 5 years from 2015 to 2020 to determine if the increase from July to August reflected a coincidental seasonal increase.

```{r line-graph-by-year}
ggplot(totals, aes(x = date, y = number, color = factor(year))) + 
  geom_line() + 
  geom_point() + 
  labs(title = "Crime Incident Trends by Year in CT", 
       x = "Date", 
       y = "Total Recorded SRS Offenses") + 
  theme(legend.position = "none") + 
  geom_vline(xintercept = as.Date("2020-07-15"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

Based on this 5-year graph of offenses, 2020 appears to follow a relatively normal seasonal pattern of increase in crimes during the summer. Especially during the months of May, June, and July, crime offenses tend to increase. Reported offenses sometimes increase more in August and sometimes decrease. The only question is whether the expected increase in SRS reported offenses from July to August is significantly exceeded in 2020.

```{r line-graph2}
ggplot(totals, aes(x = date, y = clearance_rate, color = factor(year))) + 
  geom_line() + 
  geom_point() + 
  labs(title = "Clearance Rate Trends by Year in CT", 
       x = "Date", 
       y = "Clearance Rate") + 
  theme(legend.position = "none")
```

### Exploratory Data Analysis (CO Crimes)

Colorado's qualified immunity bill was passed on June 19, 2020, and Section 3 came into effect immediately upon passage. 

```{r}
daily_totals <- co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  count(date)

monthly_totals <- co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  count(my)

co_totals %>% 
  filter(date >= as.Date("2020-01-01") & date < as.Date("2021-01-01")) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point() + 
  labs(title = "2020 Crime Incident Trends in Denver", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  ylim(100, 275) +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
co_totals %>% 
  filter(date >= as.Date("2019-01-01") & date < as.Date("2020-01-01")) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point() + 
  labs(title = "2019 Crime Incident Trends in Denver", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2019-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
co_totals %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point(alpha = 0.5) + 
  ylim(150, 300) +
  labs(title = "Daily Crime Incident Trends in Denver for 5 Years", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") + 
  geom_smooth() +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

```{r}
monthly_totals %>% 
  filter(my < as.Date("2021/05/01")) %>% 
  ggplot(aes(x = my, y = n)) +
  geom_point() + 
  geom_line() + 
  labs(title = "Monthly Crime Incident Trends in Denver for 5 Years", 
       x = "Date", 
       y = "Number of Non-Traffic Crimes") + 
  theme(legend.position = "none") +
  geom_vline(xintercept = as.Date("2020-06-19"), lty = 2, lwd = 0.5, 
             color = "red", alpha = 0.5)
```

### Analysis (CO Crimes)

```{r co-summary-stats}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2016-06-19") & date < as.Date("2017-05-21")) %>% 
  nrow()
```

```{r co-summary-stats}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2017-06-19") & date < as.Date("2018-05-21")) %>% 
  nrow()
```

```{r co-summary-stats2}
co_offenses %>% 
  filter(IS_CRIME == 1) %>% 
  filter(date >= as.Date("2020-06-19")) %>% 
  nrow()
```

