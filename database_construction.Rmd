---
title: "FBI Database Compilation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r load-packages, message = FALSE}
library(tidyverse)
library(knitr)
library(rvest)
library(lubridate)
library(infer)
library(readxl)
library(tm)
library(Synth)
set.seed(460)
```

## Load Crime Data

```{r crime-data, message = FALSE}
crime_11 <- read_csv("fbi/2011_crimes_bycity.csv")
crime_12 <- read_csv("fbi/2012_crimes_bycity.csv")
crime_13 <- read_csv("fbi/2013_crimes_bycity.csv")
crime_14 <- read_csv("fbi/2014_crimes_bycity.csv")
crime_15 <- read_csv("fbi/2015_crimes_bycity.csv")
crime_16 <- read_csv("fbi/2016_crimes_bycity.csv")
crime_17 <- read_csv("fbi/2018_crimes_bycity.csv")
crime_18 <- read_csv("fbi/2018_crimes_bycity.csv")
crime_19 <- read_csv("fbi/2019_crimes_bycity.csv")
crime_20 <- read_csv("fbi/2020_crimes_bycity.csv")

```

## Crime Data Wrangling

```{r slice-footnotes}
crime_11 <- crime_11 %>% 
  slice(1:9314)
crime_12 <- crime_12 %>% 
  slice(1:9491)
crime_13 <- crime_13 %>% 
  slice(1:9292)
crime_14 <- crime_14 %>% 
  slice(1:9347)
crime_15 <- crime_15 %>% 
  slice(1:9395)
crime_16 <- crime_16 %>% 
  slice(1:9579)
crime_17 <- crime_17 %>% 
  slice(1:9579)
crime_18 <- crime_18 %>% 
  slice(1:9252)
crime_19 <- crime_19 %>% 
  slice(1:8105)
crime_20 <- crime_20 %>% 
  slice(1:7689)

```


```{r fill-msa-names}
crime_11 <- crime_11 %>% 
  mutate(year = "2011") %>% 
  fill(State, .direction = "down")

crime_11$State <- crime_11$State %>% 
  str_replace("ALABAMA2", "ALABAMA")

crime_12 <- crime_12 %>% 
  mutate(year = "2012") %>% 
  fill(State, .direction = "down")

crime_13 <- crime_13 %>% 
  mutate(year = "2013") %>% 
  fill(State, .direction = "down")

crime_14 <- crime_14 %>% 
  mutate(year = "2014") %>% 
  fill(State, .direction = "down")

crime_15 <- crime_15 %>% 
  mutate(year = "2015") %>% 
  fill(State, .direction = "down")

crime_16 <- crime_16 %>% 
  mutate(year = "2016") %>% 
  fill(State, .direction = "down")

crime_17 <- crime_17 %>% 
  mutate(year = "2017") %>% 
  fill(State, .direction = "down")

crime_18 <- crime_18 %>% 
  mutate(year = "2018") %>% 
  fill(State, .direction = "down")

crime_19 <- crime_19 %>% 
  mutate(year = "2019") %>% 
  fill(State, .direction = "down")

crime_20$State <- crime_20$State %>% 
  str_replace("Alabama3", "Alabama")

names(crime_20)[4] <- names(crime_11)[4]
names(crime_20)[9] <- names(crime_11)[9]

crime_20 <- crime_20 %>% 
  mutate(year = "2020") %>% 
  fill(State, .direction = "down")
```

```{r combine-data}
all_crimes <- full_join(crime_11, crime_12)
all_crimes <- full_join(all_crimes, crime_13)
all_crimes <- full_join(all_crimes, crime_14)
all_crimes <- full_join(all_crimes, crime_15)
all_crimes <- full_join(all_crimes, crime_16)
all_crimes <- full_join(all_crimes, crime_17)
all_crimes <- full_join(all_crimes, crime_18)
all_crimes <- full_join(all_crimes, crime_19)
all_crimes <- full_join(all_crimes, crime_20) #can solve forcible rape/rape1 problem by just changing rape1 name to forcible rape
```

```{r wrangle-all-crimes}
names(all_crimes)[1] <- "state"
names(all_crimes)[2] <- "city"
names(all_crimes)[3] <- "population"
names(all_crimes)[4] <- "violent_crime"
names(all_crimes)[9] <- "property_crime"
all_crimes <- all_crimes %>%
  select(state, city, population, violent_crime, property_crime, year) %>% 
  mutate(violent_crime_rate = violent_crime / population * 100000) %>% 
  mutate(property_crime_rate = property_crime / population * 100000)

all_crimes$state <- removeNumbers(all_crimes$state)
all_crimes$city <- removeNumbers(all_crimes$city)
all_crimes$state <- str_remove(all_crimes$state, ", ")
all_crimes$city <- str_remove(all_crimes$city, ", ")
all_crimes$city <- str_remove(all_crimes$city, ",")
all_crimes$state <- str_to_title(all_crimes$state)
all_crimes <- all_crimes %>% 
  mutate(year = as.numeric(year))
```


## Load Census Data

```{r load-census-data, message = FALSE}
social_acs_2011 <- read_csv("census/2011_social_acs.csv")
economic_acs_2011 <- read_csv("census/2011_economic_acs.csv")
housing_acs_2011 <- read_csv("census/2011_housing_acs.csv") 
demographic_acs_2011 <- read_csv("census/2011_demographic_acs.csv")
social_acs_2012 <- read_csv("census/2012_social_acs.csv")
economic_acs_2012 <- read_csv("census/2012_economic_acs.csv")
housing_acs_2012 <- read_csv("census/2012_housing_acs.csv") 
demographic_acs_2012 <- read_csv("census/2012_demographic_acs.csv")
social_acs_2013 <- read_csv("census/2013_social_acs.csv")
economic_acs_2013 <- read_csv("census/2013_economic_acs.csv")
housing_acs_2013 <- read_csv("census/2013_housing_acs.csv") 
demographic_acs_2013 <- read_csv("census/2013_demographic_acs.csv")
social_acs_2014 <- read_csv("census/2014_social_acs.csv")
economic_acs_2014 <- read_csv("census/2014_economic_acs.csv")
housing_acs_2014 <- read_csv("census/2014_housing_acs.csv") 
demographic_acs_2014 <- read_csv("census/2014_demographic_acs.csv")
social_acs_2015 <- read_csv("census/2015_social_acs.csv")
economic_acs_2015 <- read_csv("census/2015_economic_acs.csv")
housing_acs_2015 <- read_csv("census/2015_housing_acs.csv") 
demographic_acs_2015 <- read_csv("census/2015_demographic_acs.csv")
social_acs_2016 <- read_csv("census/2016_social_acs.csv")
economic_acs_2016 <- read_csv("census/2016_economic_acs.csv")
housing_acs_2016 <- read_csv("census/2016_housing_acs.csv") 
demographic_acs_2016 <- read_csv("census/2016_demographic_acs.csv")
social_acs_2017 <- read_csv("census/2017_social_acs.csv")
economic_acs_2017 <- read_csv("census/2017_economic_acs.csv")
housing_acs_2017 <- read_csv("census/2017_housing_acs.csv") 
demographic_acs_2017 <- read_csv("census/2017_demographic_acs.csv")
social_acs_2018 <- read_csv("census/2018_social_acs.csv")
economic_acs_2018 <- read_csv("census/2018_economic_acs.csv")
housing_acs_2018 <- read_csv("census/2018_housing_acs.csv") 
demographic_acs_2018 <- read_csv("census/2018_demographic_acs.csv")
social_acs_2019 <- read_csv("census/2019_social_acs.csv")
economic_acs_2019 <- read_csv("census/2019_economic_acs.csv")
housing_acs_2019 <- read_csv("census/2019_housing_acs.csv") 
demographic_acs_2019 <- read_csv("census/2019_demographic_acs.csv")
```
  


```{r}
social_acs_2011 <- social_acs_2011 %>% 
  select(NAME, DP02_0008PE, DP02_0066PE, DP02_0079PE) %>% 
  mutate(year = "2011")
economic_acs_2011 <- economic_acs_2011 %>% 
  select(NAME, DP03_0049PE, DP03_0009PE, DP03_0062E, DP03_0074PE, DP03_0129PE) %>% 
  mutate(year = "2011")
housing_acs_2011 <- housing_acs_2011 %>% 
  select(NAME, DP04_0045PE) %>% 
  mutate(year = "2011")
demographic_acs_2011 <- demographic_acs_2011 %>% 
  select(NAME, DP05_0018PE, DP05_0072PE) %>% 
  mutate(year = "2011")
social_acs_2012 <- social_acs_2012 %>% 
  select(NAME, DP02_0008PE, DP02_0066PE, DP02_0079PE) %>% 
  mutate(year = "2012") %>% 
  slice(-1)
economic_acs_2012 <- economic_acs_2012 %>% 
  select(NAME, DP03_0049PE, DP03_0009PE, DP03_0062E, DP03_0074PE, DP03_0129PE) %>% 
  mutate(year = "2012") %>% 
  slice(-1)
housing_acs_2012 <- housing_acs_2012 %>% 
  select(NAME, DP04_0045PE) %>% 
  mutate(year = "2012") %>% 
  slice(-1)
demographic_acs_2012 <- demographic_acs_2012 %>% 
  select(NAME, DP05_0018PE, DP05_0072PE) %>% 
  mutate(year = "2012") %>% 
  slice(-1)

social_acs_2013 <- social_acs_2013 %>% 
  select(NAME, DP02_0008PE, DP02_0066PE, DP02_0079PE) %>% 
  mutate(year = "2013") %>% 
  slice(-1)
economic_acs_2013 <- economic_acs_2013 %>% 
  select(NAME, DP03_0049PE, DP03_0009PE, DP03_0062E, DP03_0074PE, DP03_0129PE) %>% 
  mutate(year = "2013") %>% 
  slice(-1)
housing_acs_2013 <- housing_acs_2013 %>% 
  select(NAME, DP04_0045PE) %>% 
  mutate(year = "2013") %>% 
  slice(-1)
demographic_acs_2013 <- demographic_acs_2013 %>% 
  select(NAME, DP05_0018PE, DP05_0072PE) %>% 
  mutate(year = "2013") %>% 
  slice(-1)

social_acs_2014 <- social_acs_2014 %>% 
  select(NAME, DP02_0008PE, DP02_0066PE, DP02_0079PE) %>% 
  mutate(year = "2014") %>% 
  slice(-1)
economic_acs_2014 <- economic_acs_2014 %>% 
  select(NAME, DP03_0049PE, DP03_0009PE, DP03_0062E, DP03_0074PE, DP03_0129PE) %>% 
  mutate(year = "2014") %>% 
  slice(-1)
housing_acs_2014 <- housing_acs_2014 %>% 
  select(NAME, DP04_0045PE) %>% 
  mutate(year = "2014") %>% 
  slice(-1)
demographic_acs_2014 <- demographic_acs_2014 %>% 
  select(NAME, DP05_0018PE, DP05_0072PE) %>% 
  mutate(year = "2014") %>% 
  slice(-1)
  
social_acs_2015 <- social_acs_2015 %>% 
  select(NAME, DP02_0008PE, DP02_0066PE, DP02_0079PE) %>% 
  mutate(year = "2015") %>% 
  slice(-1)
economic_acs_2015 <- economic_acs_2015 %>% 
  select(NAME, DP03_0049PE, DP03_0009PE, DP03_0062E, DP03_0074PE, DP03_0129PE) %>% 
  mutate(year = "2015") %>% 
  slice(-1)
housing_acs_2015 <- housing_acs_2015 %>% 
  select(NAME, DP04_0046PE) %>% 
  mutate(year = "2015") %>% 
  slice(-1)
names(housing_acs_2015)[2] <- "DP04_0045PE"
demographic_acs_2015 <- demographic_acs_2015 %>% 
  select(NAME, DP05_0018PE, DP05_0072PE) %>% 
  mutate(year = "2015") %>% 
  slice(-1)

social_acs_2016 <- social_acs_2016 %>% 
  select(NAME, DP02_0008PE, DP02_0066PE, DP02_0079PE) %>% 
  mutate(year = "2016") %>% 
  slice(-1)
economic_acs_2016 <- economic_acs_2016 %>% 
  select(NAME, DP03_0049PE, DP03_0009PE, DP03_0062E, DP03_0074PE, DP03_0129PE) %>% 
  mutate(year = "2016") %>% 
  slice(-1)
housing_acs_2016 <- housing_acs_2016 %>% 
  select(NAME, DP04_0046PE) %>% 
  mutate(year = "2016") %>% 
  slice(-1)
names(housing_acs_2016)[2] <- "DP04_0045PE"
demographic_acs_2016 <- demographic_acs_2016 %>% 
  select(NAME, DP05_0018PE, DP05_0072PE) %>% 
  mutate(year = "2016") %>% 
  slice(-1)

social_acs_2017 <- social_acs_2017 %>% 
  select(NAME, DP02_0008PE, DP02_0066PE, DP02_0079PE) %>% 
  mutate(year = "2017") %>% 
  slice(-1)
economic_acs_2017 <- economic_acs_2017 %>% 
  select(NAME, DP03_0049PE, DP03_0009PE, DP03_0062E, DP03_0074PE, DP03_0129PE) %>% 
  mutate(year = "2017") %>% 
  slice(-1)
housing_acs_2017 <- housing_acs_2017 %>% 
  select(NAME, DP04_0046PE) %>% 
  mutate(year = "2017") %>% 
  slice(-1)
names(housing_acs_2017)[2] <- "DP04_0045PE"
demographic_acs_2017 <- demographic_acs_2017 %>% 
  select(NAME, DP05_0021PE, DP05_0077PE) %>% 
  mutate(year = "2017") %>% 
  slice(-1)
names(demographic_acs_2017)[2] = "DP05_0018PE"
names(demographic_acs_2017)[3] = "DP05_0072PE"

social_acs_2018 <- social_acs_2018 %>% 
  select(NAME, DP02_0008PE, DP02_0066PE, DP02_0079PE) %>% 
  mutate(year = "2018") %>% 
  slice(-1)
economic_acs_2018 <- economic_acs_2018 %>% 
  select(NAME, DP03_0049PE, DP03_0009PE, DP03_0062E, DP03_0074PE, DP03_0129PE) %>% 
  mutate(year = "2018") %>% 
  slice(-1)
housing_acs_2018 <- housing_acs_2018 %>% 
  select(NAME, DP04_0046PE) %>% 
  mutate(year = "2018") %>% 
  slice(-1)
names(housing_acs_2018)[2] <- "DP04_0045PE"
demographic_acs_2018 <- demographic_acs_2018 %>% 
  select(NAME, DP05_0021PE, DP05_0077PE) %>% 
  mutate(year = "2018") %>% 
  slice(-1)
names(demographic_acs_2018)[2] = "DP05_0018PE"
names(demographic_acs_2018)[3] = "DP05_0072PE"

social_acs_2019 <- social_acs_2019 %>% 
  select(NAME, DP02_0011PE, DP02_0067PE, DP02_0080PE) %>% 
  mutate(year = "2019") %>% 
  slice(-1)
names(social_acs_2019)[2] = "DP02_0008PE"
names(social_acs_2019)[3] = "DP02_0066PE"
names(social_acs_2019)[4] = "DP02_0079PE"
economic_acs_2019 <- economic_acs_2019 %>% 
  select(NAME, DP03_0049PE, DP03_0009PE, DP03_0062E, DP03_0074PE, DP03_0129PE) %>% 
  mutate(year = "2019") %>% 
  slice(-1)
housing_acs_2019 <- housing_acs_2019 %>% 
  select(NAME, DP04_0046PE) %>% 
  mutate(year = "2019") %>% 
  slice(-1)
names(housing_acs_2019)[2] <- "DP04_0045PE"
demographic_acs_2019 <- demographic_acs_2019 %>% 
  select(NAME, DP05_0021PE, DP05_0077PE) %>% 
  mutate(year = "2019") %>% 
  slice(-1)
names(demographic_acs_2019)[2] = "DP05_0018PE"
names(demographic_acs_2019)[3] = "DP05_0072PE"

```

```{r join-datasets, message = FALSE}
social_acs <- full_join(social_acs_2011, social_acs_2012)
social_acs <- full_join(social_acs, social_acs_2013)
social_acs <- full_join(social_acs, social_acs_2014)
social_acs <- full_join(social_acs, social_acs_2015)
social_acs <- full_join(social_acs, social_acs_2016)
social_acs <- full_join(social_acs, social_acs_2017)
social_acs <- full_join(social_acs, social_acs_2018)
social_acs <- full_join(social_acs, social_acs_2019)
economic_acs <- full_join(economic_acs_2011, economic_acs_2012)
economic_acs <- full_join(economic_acs, economic_acs_2013)
economic_acs <- full_join(economic_acs, economic_acs_2014)
economic_acs <- full_join(economic_acs, economic_acs_2015)
economic_acs <- full_join(economic_acs, economic_acs_2016)
economic_acs <- full_join(economic_acs, economic_acs_2017)
economic_acs <- full_join(economic_acs, economic_acs_2018)
economic_acs <- full_join(economic_acs, economic_acs_2019)
demographic_acs <- full_join(demographic_acs_2011, demographic_acs_2012)
demographic_acs <- full_join(demographic_acs, demographic_acs_2013)
demographic_acs <- full_join(demographic_acs, demographic_acs_2014)
demographic_acs <- full_join(demographic_acs, demographic_acs_2015)
demographic_acs <- full_join(demographic_acs, demographic_acs_2016)
demographic_acs <- full_join(demographic_acs, demographic_acs_2017)
demographic_acs <- full_join(demographic_acs, demographic_acs_2018)
demographic_acs <- full_join(demographic_acs, demographic_acs_2019)
housing_acs <- full_join(housing_acs_2011, housing_acs_2012)
housing_acs <- full_join(housing_acs, housing_acs_2013)
housing_acs <- full_join(housing_acs, housing_acs_2014)
housing_acs <- full_join(housing_acs, housing_acs_2015)
housing_acs <- full_join(housing_acs, housing_acs_2016)
housing_acs <- full_join(housing_acs, housing_acs_2017)
housing_acs <- full_join(housing_acs, housing_acs_2018)
housing_acs <- full_join(housing_acs, housing_acs_2019)

```

```{r change-names}
names(social_acs)[2] <- "female_household"
names(social_acs)[3] <- "hs"
names(social_acs)[4] <- "res_stability"
names(demographic_acs)[2] <- "over_18"
names(demographic_acs)[3] <- "white_percent"
names(economic_acs)[2] <- "self_employed"
names(economic_acs)[3] <- "unemployment"
names(economic_acs)[4] <- "median_income"
names(economic_acs)[5] <- "received_snap"
names(economic_acs)[6] <- "child_poverty"
names(housing_acs)[2] <- "owner_occupied"

social_acs <- social_acs %>% 
  slice(-1)

demographic_acs <- demographic_acs %>% 
  slice(-1)

economic_acs <- economic_acs %>% 
  slice(-1)

housing_acs <- housing_acs %>% 
  slice(-1)

```


```{r combine-acs}
full_acs <- full_join(social_acs, demographic_acs, by = c("NAME", "year"), include = TRUE)
full_acs <- full_join(full_acs, economic_acs, by = c("NAME", "year"), include - TRUE) 
full_acs <- full_join(full_acs, housing_acs, by = c("NAME", "year"), include = TRUE)
```


```{r full-acs}
full_acs <- full_acs %>% 
  mutate(female_household = as.numeric(female_household), 
         hs = as.numeric(hs), 
         res_stability = as.numeric(res_stability), 
         over_18 = as.numeric(over_18), 
         white_percent = as.numeric(white_percent), 
         self_employed = as.numeric(self_employed), 
         unemployment = as.numeric(unemployment), 
         median_income = as.numeric(median_income), 
         received_snap = as.numeric(received_snap), 
         child_poverty = as.numeric(child_poverty), 
         owner_occupied = as.numeric(owner_occupied), 
         year = as.numeric(year)) 
full_acs$NAME <- gsub("\\s*\\([^\\)]+\\)","",as.character(full_acs$NAME)) # Code taken from https://stackoverflow.com/questions/24173194/remove-parentheses-and-text-within-from-strings-in-r to remove parentheses
full_acs$NAME <- str_replace(full_acs$NAME, " city, ", ", ")
full_acs$NAME <- str_replace(full_acs$NAME, " municipality, ", ", ")
full_acs$NAME <- str_replace(full_acs$NAME, " village, ", ", ")
full_acs$NAME <- str_replace(full_acs$NAME, " town, ", ", ")
full_acs$NAME <- str_replace(full_acs$NAME, " CDP, ", ", ")
full_acs$NAME <- str_replace(full_acs$NAME, "San Buenaventura", "Ventura")
full_acs$NAME <- str_replace(full_acs$NAME, "Washington, District of Columbia", 
                             "Washington, District Of Columbia")
full_acs$NAME <- str_replace(full_acs$NAME, "Savannah, Georgia", 
                             "Savannah-Chatham Metropolitan, Georgia")
full_acs$NAME <- str_remove(full_acs$NAME, "-Davidson metropolitan government")
full_acs$NAME <- str_remove(full_acs$NAME, "-Fayette urban county")
full_acs$NAME <- str_replace(full_acs$NAME, "/Jefferson County metro government", " Metro")
full_acs$city <- str_split(full_acs$NAME, ", ", simplify = TRUE)[,1]
full_acs$state <- str_split(full_acs$NAME, ", ", simplify = TRUE)[,2]

full_acs_modified <- full_acs
full_acs_modified$city <- paste0(full_acs_modified$city, " Township")
```

```{r left-join}
all_crimes$city <- str_replace(all_crimes$city, "Las Vegas Metropolitan Police Department", 
                               "Las Vegas")
all_crimes$city <- str_replace(all_crimes$city, "Charlotte-Mecklenburg", "Charlotte")

full_database <- left_join(all_crimes, full_acs, by = c("city", "state", "year"))
```

```{r save-work}
write_csv(full_database, "data/crime_database.csv") #finished database creation
```

## Wrangling Completed Database

```{r read-full, message = FALSE}
full_database <- read_csv("data/crime_database.csv")
```


```{r fix-damages}
reduced_database <- full_database %>% 
  filter(population >= 50000) %>% 
  filter(is.na(NAME) == FALSE)
```

```{r remove-duplicates, message = FAL}
for_removal <- reduced_database %>% 
  filter(NAME == "Burbank, California") %>% 
  filter(white_percent < 40)

for_removal2 <- reduced_database %>% 
  filter(NAME == "Mesquite, Texas") %>% 
  filter(white_percent == 0.0)
for_removal <- full_join(for_removal, for_removal2)

for_removal2 <- reduced_database %>% 
  filter(NAME == "Mountain View, California") %>% 
  filter(white_percent > 48)
for_removal <- full_join(for_removal, for_removal2)

for_removal2 <- reduced_database %>% 
  filter(NAME == "Plantation, Florida") %>% 
  filter(white_percent > 90)
for_removal <- full_join(for_removal, for_removal2)

reduced_database <- anti_join(reduced_database, for_removal)
```

## Correlation Diagnostics - Linear Models to Replicate Conclusions

```{r}
lm_database <- reduced_database %>% 
  filter(year != 2020)
lm_database2 <- reduced_database %>% 
  filter(year == 2019)
```

```{r}
diag1 <- lm(violent_crime_rate ~ female_household + hs + res_stability + over_18 + white_percent +
   self_employed + unemployment + median_income + child_poverty + owner_occupied, data = lm_database)
tidy(diag1)
```

```{r}
diag2 <- lm(violent_crime_rate ~ female_household + hs + res_stability + over_18 + white_percent +
   self_employed + unemployment + median_income + child_poverty + owner_occupied, data = lm_database2)
tidy(diag2)
```

## Synthetic Control Modelling for Violent Crimes

```{r}
reduced_database_violent <- reduced_database %>% 
  filter(is.na(violent_crime_rate) == FALSE & is.na(female_household) == FALSE & 
         is.na(hs) == FALSE & is.na(res_stability) == FALSE & is.na(over_18) == FALSE & 
         is.na(white_percent) == FALSE & is.na(self_employed) == FALSE & is.na(unemployment) == FALSE & 
         is.na(median_income) == FALSE & is.na(child_poverty) == FALSE & is.na(owner_occupied) == FALSE)
counts <- reduced_database_violent %>% 
  count(NAME, sort = TRUE)
remove_missing <- counts %>% 
  filter (n < 9)
reduced_database2 <- anti_join(reduced_database_violent, remove_missing)

```



```{r}
add_numbers_violent <- reduced_database2 %>% 
  filter(NAME == "Denver, Colorado" | NAME == "Colorado Springs, Colorado" | state != "Colorado") %>% 
  distinct(NAME) 

add_numbers_violent <- add_numbers_violent %>% 
  mutate(id = 1:nrow(add_numbers_violent))

reduced_database2 <- full_join(reduced_database2, add_numbers_violent, by = "NAME")
```

```{r remove-non-denver-colorado}
no_colorado <- reduced_database2 %>% 
  filter(NAME == "Denver, Colorado" | NAME == "Colorado Springs, Colorado" | state != "Colorado") %>% 
  mutate(id = as.numeric(id)) 
no_colorado <- no_colorado %>% 
  mutate(year = as.numeric(year)) 
no_colorado <- as.data.frame(no_colorado)
```

1:184, 187:514

```{r}
prep <- dataprep(foo = no_colorado, predictors = c("population", "female_household", 
                                                "hs", "res_stability", "over_18", 
                                                "white_percent", "self_employed", 
                                                "unemployment", "median_income", 
                                                "child_poverty", "owner_occupied"), 
         predictors.op = "mean", dependent = "violent_crime_rate", unit.variable = 
         "id", time.variable = "year", unit.names.variable = "NAME", 
         treatment.identifier = 186, controls.identifier = c(1:184, 187:514), 
         time.predictors.prior = 2011:2018, time.optimize.ssr = 2014:2019, 
         time.plot = 2011:2019)
         
```



```{r}
synth_complete <- synth(prep)
```

```{r}
path.plot(synth.res = synth_complete,
dataprep.res = prep,
Ylab = c("Violent Crime Rates"),
Xlab = c("Year"),
Legend = c("Denver, CO","Synthetic Denver")
)
```

```{r}
weights <- synth_complete$solution.w
weights <- tibble(weight = weights, id = rownames(weights))

```

```{r}
weights <- weights %>% 
  arrange(desc(weight)) %>% 
  mutate(id = as.numeric(id)) %>% 
  full_join(add_numbers_violent, by = "id")
```

Violent Crimes for Denver (all 9 years):

Seattle, Washington (496)
Houston, TX (449)
Fort Smith, AR (14)
Champaign, IL (266)
Ann Arbor, MI (328)

I reran the synthetic control model with just the four cities with data to reweight the averages.

```{r}
prep_test <- dataprep(foo = no_colorado, predictors = c("population", "female_household", 
                                                "hs", "res_stability", "over_18", 
                                                "white_percent", "self_employed", 
                                                "unemployment", "median_income", 
                                                "child_poverty", "owner_occupied"), 
         predictors.op = "mean", dependent = "violent_crime_rate", unit.variable = 
         "id", time.variable = "year", unit.names.variable = "NAME", 
         treatment.identifier = 186, controls.identifier = c(496, 449, 14, 266), 
         time.predictors.prior = 2011:2019, time.optimize.ssr = 2014:2019, 
         time.plot = 2011:2019)
         
```

```{r}
synth_complete_test <- synth(prep_test)
```

```{r}
path.plot(synth.res = synth_complete_test,
dataprep.res = prep,
Ylab = c("Violent Crime Rates"),
Xlab = c("Year"),
Legend = c("Denver, CO","Synthetic Denver")
)
```

```{r}

weights_denver_violent <- synth_complete_test$solution.w
weights_denver_violent <- tibble(weight = weights_denver_violent, id = rownames(weights_denver_violent))

weights_denver_violent <- weights_denver_violent %>% 
  arrange(desc(weight)) %>% 
  mutate(id = as.numeric(id)) %>% 
  full_join(add_numbers_violent, by = "id") %>% 
  slice(1:4)
```

Although the graph comparing the synthetic control and Denver is somewhat worse than the other synthetic control graph, this graph depicts close enough trends between the synthetic control model and Denver to warrant running a test comparing the violent crime rates in both cities over the time period.

#### Colorado Springs


```{r prep-co-springs}
prep_cosprings <- dataprep(foo = no_colorado, predictors = c("population", 
                                                              "female_household", 
                                                "hs", "res_stability", "over_18", 
                                                "white_percent", "self_employed", 
                                                "unemployment", "median_income", 
                                                "child_poverty", "owner_occupied"), 
         predictors.op = "mean", dependent = "violent_crime_rate", unit.variable = 
         "id", time.variable = "year", unit.names.variable = "NAME", 
         treatment.identifier = 185, controls.identifier = c(1:184, 187:259, 261:327, 
                                                             329:514), 
         time.predictors.prior = 2011:2018, time.optimize.ssr = 2016:2019, 
         time.plot = 2011:2019)
```

```{r synthetic-control-co-springs}
synth_co_springs <- synth(prep_cosprings)
```

```{r plot-synthetic-cosprings}
path.plot(synth.res = synth_co_springs,
dataprep.res = prep_cosprings,
Ylab = c("Violent Crime Rates"),
Xlab = c("Year"),
Legend = c("Colorado Springs","Synthetic Colorado Springs")
)
```

Synthetic Colorado Springs does not appear to closely match CO Springs' trend from 2015 to 2019, although it does somewhat match the trend from 2011 to 2015. Perhaps rerunning the synthetic control with just 2015 to 2019?

```{r}
weights <- synth_co_springs$solution.w
weights <- tibble(weight = weights, id = rownames(weights))

weights <- weights %>% 
  arrange(desc(weight)) %>% 
  mutate(id = as.numeric(id)) %>% 
  full_join(add_numbers_violent, by = "id")
```



Meridian, Idaho - 260
Lawton, Oklahoma - 400
Ann Arbor, Michigan - 328
Chico, California - 36
South Jordan, Utah - 478

## Synthetic Control Modelling for Property Crimes

```{r}
reduced_database_property <- reduced_database %>% 
  filter(is.na(property_crime_rate) == FALSE 
         & is.na(population) == FALSE & 
           is.na(female_household) == FALSE & is.na(hs) == FALSE & 
           is.na(res_stability) == FALSE & is.na(over_18) == FALSE & 
         is.na(white_percent) == FALSE & is.na(self_employed) == FALSE & is.na(unemployment) == FALSE & 
         is.na(median_income) == FALSE & is.na(child_poverty) == FALSE & is.na(owner_occupied) == FALSE)
counts <- reduced_database_property %>% 
  count(NAME, sort = TRUE)
remove_missing <- counts %>% 
  filter (n < 9)
reduced_database2 <- anti_join(reduced_database_property, remove_missing)

```



```{r}
add_numbers <- reduced_database2 %>% 
  filter(NAME == "Denver, Colorado" | NAME == "Colorado Springs, Colorado" | state != "Colorado") %>% 
  distinct(NAME) 

add_numbers <- add_numbers %>% 
  mutate(id = 1:nrow(add_numbers))

reduced_database2 <- full_join(reduced_database2, add_numbers, by = "NAME")
```


```{r remove-non-denver-colorado}
no_colorado1 <- reduced_database2 %>% 
  filter(NAME == "Denver, Colorado" | NAME == "Colorado Springs, Colorado" | state != "Colorado") %>% 
  mutate(id = as.numeric(id)) 
no_colorado1 <- no_colorado1 %>% 
  mutate(year = as.numeric(year)) 
no_colorado1 <- as.data.frame(no_colorado1)
```


```{r denver-prep}
denver_prop_prep <- dataprep(foo = no_colorado1, predictors = c("population", "female_household", 
                                                "hs", "res_stability", "over_18", 
                                                "white_percent", "self_employed", 
                                                "unemployment", "median_income", 
                                                "child_poverty", "owner_occupied"), 
         predictors.op = "mean", dependent = "property_crime_rate", unit.variable = 
         "id", time.variable = "year", unit.names.variable = "NAME", 
         treatment.identifier = 186, controls.identifier = c(1:184, 187:531), 
         time.predictors.prior = 2011:2018, time.optimize.ssr = 2016:2019, 
         time.plot = 2011:2019)
         
```




```{r}
synth_denver_property <- synth(denver_prop_prep)
```

```{r}
path.plot(synth.res = synth_denver_property,
dataprep.res = denver_prop_prep,
Ylab = c("Property Crime Rates"),
Xlab = c("Year"),
Legend = c("Denver, CO","Synthetic Denver")
)
```

```{r}
weights_denver_prop <- synth_denver_property$solution.w
weights_denver_prop <- tibble(weight = weights_denver_prop, id = rownames(weights_denver_prop))
weights_denver_prop <- weights_denver_prop %>% 
  arrange(desc(weight)) %>% 
  mutate(id = as.numeric(id))
weights_denver_prop <- full_join(weights_denver_prop, add_numbers, by = "id")
```


```{r synth-test-prep}
denver_prop_prep_test <- dataprep(foo = no_colorado1, predictors = c("population", "female_household", 
                                                "hs", "res_stability", "over_18", 
                                                "white_percent", "self_employed", 
                                                "unemployment", "median_income", 
                                                "child_poverty", "owner_occupied"), 
         predictors.op = "mean", dependent = "property_crime_rate", unit.variable = 
         "id", time.variable = "year", unit.names.variable = "NAME", 
         treatment.identifier = 186, controls.identifier = c(466, 266, 512, 14, 449), 
         time.predictors.prior = 2011:2018, time.optimize.ssr = 2016:2019, 
         time.plot = 2011:2019)
```

```{r synth-test}
synth_denver_property_test <- synth(denver_prop_prep_test)
```

```{r}
path.plot(synth.res = synth_denver_property_test,
dataprep.res = denver_prop_prep_test,
Ylab = c("Property Crime Rates"),
Xlab = c("Year"),
Legend = c("Denver, CO","Synthetic Denver")
)
```

```{r}
weights_denver_prop_test <- synth_denver_property_test$solution.w
weights_denver_prop_test <- tibble(weight = weights_denver_prop_test, id = rownames(weights_denver_prop_test))
weights_denver_prop_test <- weights_denver_prop_test %>% 
  arrange(desc(weight)) %>% 
  mutate(id = as.numeric(id))
weights_denver_prop_test <- full_join(weights_denver_prop_test, add_numbers, by = "id")
```

449 - Austin, TX - 0.6936


```{r cspd-prep}
cspd_prop_prep <- dataprep(foo = no_colorado1, predictors = c("population", "female_household", 
                                                "hs", "res_stability", "over_18", 
                                                "white_percent", "self_employed", 
                                                "unemployment", "median_income", 
                                                "child_poverty", "owner_occupied"), 
         predictors.op = "mean", dependent = "property_crime_rate", unit.variable = 
         "id", time.variable = "year", unit.names.variable = "NAME", 
         treatment.identifier = 185, controls.identifier = c(1:184, 187:327, 329:531), 
         time.predictors.prior = 2011:2018, time.optimize.ssr = 2016:2019, 
         time.plot = 2011:2019)
         
```




```{r}
synth_cspd_property_true <- synth(cspd_prop_prep)
```

```{r}
path.plot(synth.res = synth_cspd_property_true,
dataprep.res = cspd_prop_prep,
Ylab = c("Property Crime Rates"),
Xlab = c("Year"),
Legend = c("Colorado Springs, CO","Synthetic Colorado Springs")
)
```

```{r}
weights_cspd_prop <- synth_cspd_property_true$solution.w
weights_cspd_prop <- tibble(weight = weights_cspd_prop, id = rownames(weights_cspd_prop))
weights_cspd_prop <- weights_cspd_prop %>% 
  arrange(desc(weight)) %>% 
  mutate(id = as.numeric(id)) %>% 
  full_join(add_numbers, by = "id")
```

414 - Clarksville, TN
260 - Meridian, ID
326 - Ann Arbor, MI
472
431
6


### Sensitivity Analysis on CSPD



```{r cspd-filter}
reduced_database_property_cspd <- reduced_database %>% 
  filter(is.na(property_crime_rate) == FALSE 
         & is.na(population) == FALSE & 
           is.na(female_household) == FALSE & is.na(hs) == FALSE & 
           is.na(res_stability) == FALSE & is.na(over_18) == FALSE & 
         is.na(white_percent) == FALSE & is.na(self_employed) == FALSE & is.na(unemployment) == FALSE & 
         is.na(median_income) == FALSE & is.na(child_poverty) == FALSE & 
           is.na(owner_occupied) == FALSE) %>% 
  filter(property_crime_rate >= 2000 & property_crime_rate <= 6000)
counts <- reduced_database_property_cspd %>% 
  count(NAME, sort = TRUE)
remove_missing <- counts %>% 
  filter (n < 9)
reduced_database3 <- anti_join(reduced_database_property_cspd, remove_missing)

add_numbers <- reduced_database3 %>% 
  filter(NAME == "Denver, Colorado" | NAME == "Colorado Springs, Colorado" | state != "Colorado") %>% 
  distinct(NAME) 

add_numbers <- add_numbers %>% 
  mutate(id = 1:nrow(add_numbers))

reduced_database3 <- full_join(reduced_database3, add_numbers, by = "NAME")

no_colorado2 <- reduced_database3 %>% 
  filter(NAME == "Denver, Colorado" | NAME == "Colorado Springs, Colorado" | state != "Colorado") %>% 
  mutate(id = as.numeric(id)) 
no_colorado2 <- no_colorado2 %>% 
  mutate(year = as.numeric(year)) 
no_colorado2 <- as.data.frame(no_colorado2)

```
1:184, 187:531

```{r cspd-prep}
cspd_prop_prep <- dataprep(foo = no_colorado2, predictors = c("population", "female_household", 
                                                "hs", "res_stability", "over_18", 
                                                "white_percent", "self_employed", 
                                                "unemployment", "median_income", 
                                                "child_poverty", "owner_occupied"), 
         predictors.op = "mean", dependent = "property_crime_rate", unit.variable = 
         "id", time.variable = "year", unit.names.variable = "NAME", 
         treatment.identifier = 93, controls.identifier = c(1:92, 95:257), 
         time.predictors.prior = 2011:2018, time.optimize.ssr = 2016:2019, 
         time.plot = 2011:2019)
         
```

```{r}
cspd_prop_prep$X0 <- as.matrix(cspd_prop_prep$X0[,colSums(cspd_prop_prep$X0 != 0) != 0])
cspd_prop_prep$X1 <- as.matrix(cspd_prop_prep$X1[,colSums(cspd_prop_prep$X1 != 0) != 0])
cspd_prop_prep$Z0 <- as.matrix(cspd_prop_prep$Z0[,colSums(cspd_prop_prep$Z0 != 0) != 0])
cspd_prop_prep$Z1 <- as.matrix(cspd_prop_prep$Z1[,colSums(cspd_prop_prep$Z1 != 0) != 0])
cspd_prop_prep$names.and.numbers <- as.matrix(cspd_prop_prep$names.and.numbers[,colSums(cspd_prop_prep$names.and.numbers != 0) != 0])


```


```{r}
synth_cspd_property_sensitivity <- synth(cspd_prop_prep)
```


```{r}
path.plot(synth.res = synth_cspd_property_sensitivity,
dataprep.res = cspd_prop_prep,
Ylab = c("Property Crime Rates"),
Xlab = c("Year"),
Legend = c("Colorado Springs, CO","Synthetic Colorado Springs")
)
```

```{r}
weights_cspd_prop <- synth_cspd_property_sensitivity$solution.w
weights_cspd_prop <- tibble(weight = weights_cspd_prop, id = rownames(weights_cspd_prop))
weights_cspd_prop <- weights_cspd_prop %>% 
  arrange(desc(weight)) %>% 
  mutate(id = as.numeric(id)) %>% 
  full_join(add_numbers, by = "id")
```

21 - Jacksonville, Florida
15 - Walnut Creek, California

```{r save-all}
saveRDS(synth_complete, 
        file = "/Users/andrewqin02/Desktop/R/NPAP/data/denver_violent_synth.Rdata")
saveRDS(synth_complete_test, 
        file = "/Users/andrewqin02/Desktop/R/NPAP/data/denver_violent_true.Rdata")
saveRDS(synth_denver_property, 
        file = "/Users/andrewqin02/Desktop/R/NPAP/data/denver_property_synth.Rdata")
saveRDS(synth_denver_property_test, 
        file = "/Users/andrewqin02/Desktop/R/NPAP/data/denver_property_true.Rdata")
```